<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title id="pT">Ficha Atleta - Control Voley</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        :root{--m:#001F3F;--e:#0074D9;--f:#f0f8ff}
        body{font-family:'Inter',sans-serif;background:var(--f)}
        .b-h{background-image:url('img/banner.png');background-size:cover;background-position:center;min-height:200px;width:100%}
        .m-c{background:#f7f9fb;border-left:4px solid var(--e)}
    </style>
</head>
<body>
    <div class="b-h"></div>
    <div class="container mx-auto p-4">
        <header class="mb-6 flex justify-between items-center border-b pb-4">
            <div class="flex items-center space-x-3">
                <a href="index_ficha.html" class="text-gray-500 hover:text-blue-600 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 15l-3-3m0 0l3-3m-3 3h8M3 12a9 9 0 1118 0 9 9 0 01-18 0z"/>
                    </svg>
                </a>
                <h1 class="text-2xl font-black text-gray-800">Ficha: <span id="aNT" class="text-blue-600">...</span></h1>
            </div>
            <button onclick="logout()" class="py-1 px-4 bg-red-600 text-white rounded-lg text-sm font-bold shadow hover:bg-red-700 transition">Salir</button>
        </header>

        <div id="aDC" class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
            <p id="lM" class="text-center py-10 text-gray-400 italic">Cargando datos del atleta...</p>
            
            <div id="aD" class="hidden">
                <h2 class="text-lg font-bold mb-4 text-blue-900 border-b pb-2">Datos Personales</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8 text-sm">
                    <div><span class="font-semibold text-gray-500">Nombre Completo:</span> <span id="nAp" class="text-gray-900 block font-medium"></span></div>
                    <div><span class="font-semibold text-gray-500">Cédula de Identidad:</span> <span id="cI" class="text-gray-900 block font-medium"></span></div>
                    <div><span class="font-semibold text-gray-500">Teléfono Contacto:</span> <span id="tel" class="text-gray-900 block font-medium"></span></div>
                    <div><span class="font-semibold text-gray-500">Fecha de Nacimiento:</span> <span id="fNa" class="text-gray-900 block font-medium"></span></div>
                    <div><span class="font-semibold text-gray-500">Edad Actual:</span> <span id="eda" class="text-blue-700 font-bold block text-base"></span></div>
                    <div><span class="font-semibold text-gray-500">Categoría:</span> <span id="cat" class="text-blue-600 font-bold block text-base"></span></div>
                    <div><span class="font-semibold text-gray-500">Número Camiseta:</span> <span id="nCa" class="text-indigo-600 font-black text-xl block"></span></div>
                </div>

                <h2 class="text-lg font-bold mb-4 text-blue-900 border-b pb-2">Pagos y Métricas Físicas</h2>
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="m-c p-4 rounded-lg shadow-sm"> 
                        <p class="text-xs text-gray-500 font-bold uppercase">Monto Nómina <span id="nomT"></span></p> 
                        <p id="mPa" class="text-2xl font-black text-gray-800"></p>
                    </div>
                    <div class="m-c p-4 rounded-lg shadow-sm"> 
                        <p class="text-xs text-gray-500 font-bold uppercase">Último Pago</p> 
                        <p id="uPa" class="text-sm font-bold text-gray-800 mt-2"></p>
                    </div>
                    <div class="m-c p-4 rounded-lg shadow-sm"> 
                        <p class="text-xs text-gray-500 font-bold uppercase mb-2">Solvencia</p> 
                        <span id="sSt" class="text-xs font-bold px-3 py-1 rounded-full"></span>
                    </div>
                    <div class="m-c p-4 rounded-lg shadow-sm"> 
                        <p class="text-xs text-gray-500 font-bold uppercase">IMC (Estado)</p> 
                        <p id="imc" class="text-2xl font-black text-gray-800"></p> 
                        <span id="iSt" class="text-[10px] font-bold px-2 py-0.5 rounded uppercase"></span>
                    </div>
                    <div class="m-c p-4 rounded-lg shadow-sm"> 
                        <p class="text-xs text-gray-500 font-bold uppercase">Peso</p> 
                        <p id="pes" class="text-2xl font-black text-gray-800"></p>
                    </div>
                    <div class="m-c p-4 rounded-lg shadow-sm"> 
                        <p class="text-xs text-gray-500 font-bold uppercase">Talla Actual</p> 
                        <p id="tal" class="text-2xl font-black text-gray-800"></p>
                    </div>
                    <div class="m-c p-4 rounded-lg shadow-sm bg-blue-50"> 
                        <p class="text-xs text-blue-700 font-bold uppercase">Proyección Talla</p> 
                        <p id="tPr" class="text-2xl font-black text-blue-800"></p>
                        <p class="text-[9px] text-blue-500 mt-1">*Estimado por categoría</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB5RB7mm1j-0gjCNTUEJTkyEqLjyZ3C7ws",
            authDomain: "datacontrolvoley-ff556.firebaseapp.com",
            projectId: "datacontrolvoley-ff556",
            storageBucket: "datacontrolvoley-ff556.firebasestorage.app",
            messagingSenderId: "516409072606",
            appId: "1:516409072606:web:132538dba358a077d71b4f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const _ = id => document.getElementById(id);

        const getParam = n => (new RegExp('[?&]'+n+'=([^&#]*)')).exec(window.location.search)?.[1] || '';

        const calcEdad = d => {
            if(!d) return 'N/A';
            const b = new Date(d), n = new Date();
            let a = n.getFullYear() - b.getFullYear();
            if(n.getMonth() < b.getMonth() || (n.getMonth() === b.getMonth() && n.getDate() < b.getDate())) a--;
            return a;
        };

        const getImcStatus = v => {
            if(!v || v === 0) return {t:'N/A', c:'bg-gray-200 text-gray-600'};
            if(v < 18.5) return {t:'BAJO PESO', c:'bg-yellow-400 text-white'};
            if(v <= 24.9) return {t:'NORMAL', c:'bg-green-500 text-white'};
            if(v <= 29.9) return {t:'SOBREPESO', c:'bg-orange-500 text-white'};
            return {t:'OBESIDAD', c:'bg-red-600 text-white'};
        };

        const checkSolvency = (fecha, frecuencia) => {
            if(!fecha) return {s:'Insolvente', c:'bg-red-500 text-white'};
            const diff = (new Date() - new Date(fecha)) / (1000 * 60 * 60 * 24);
            const limit = frecuencia === 'quincenal' ? 15 : 30;
            return diff <= limit ? {s:'Solvente', c:'bg-green-500 text-white'} : {s:'Insolvente', c:'bg-yellow-500 text-black'};
        };

        const loadAthleteData = async id => {
            try {
                const docSnap = await getDoc(doc(db, 'club_athletes', id));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // Mapeo de datos (Asegurando compatibilidad con index_atletas)
                    const atleta = {
                        nombreCompleto: `${data.nombre || ''} ${data.apellido || ''}`,
                        ci: data.cedulaIdentidad || 'N/A',
                        tel: data.telefono || 'N/A',
                        fNac: data.fechaNacimiento || null,
                        cat: data.categoria || 'N/A',
                        num: data.nroCamiseta ?? '-',
                        peso: parseFloat(data.peso) || 0,
                        talla: parseFloat(data.talla) || 0, // En cm
                        frec: data.frecuenciaPago || 'mensual',
                        uPago: data.fechaUltimoPago || null,
                        monto: data.montoPago || 0
                    };

                    // 1. CÁLCULO IMC (Peso / Altura en m²)
                    const tallaMetros = atleta.talla / 100;
                    const imcValue = (atleta.peso > 0 && tallaMetros > 0) ? (atleta.peso / (tallaMetros * tallaMetros)) : 0;
                    
                    // 2. PROYECCIÓN DE TALLA (Basada en crecimiento esperado por categoría)
                    let crecimientoEstimado = 0;
                    if(atleta.talla > 0) {
                        const c = atleta.cat;
                        if(['U9','U11'].includes(c)) crecimientoEstimado = 15;
                        else if(c === 'U13') crecimientoEstimado = 10;
                        else if(c === 'U15') crecimientoEstimado = 6;
                        else if(c === 'U19') crecimientoEstimado = 2;
                    }
                    const proyMetros = atleta.talla > 0 ? (atleta.talla + crecimientoEstimado) / 100 : 0;

                    const solvencia = checkSolvency(atleta.uPago, atleta.frec);
                    const imcEst = getImcStatus(imcValue);

                    // Llenar UI
                    _('aNT').innerText = atleta.nombreCompleto;
                    _('pT').innerText = 'Ficha: ' + atleta.nombreCompleto;
                    _('nAp').innerText = atleta.nombreCompleto;
                    _('cI').innerText = atleta.ci;
                    _('tel').innerText = atleta.tel;
                    _('fNa').innerText = atleta.fNac || 'No registrada';
                    _('eda').innerText = calcEdad(atleta.fNac) + ' años';
                    _('cat').innerText = atleta.cat;
                    _('nCa').innerText = atleta.num;
                    
                    _('nomT').innerText = atleta.frec === 'quincenal' ? '(Q)' : '(M)';
                    _('mPa').innerText = parseFloat(atleta.monto).toFixed(2) + '$';
                    _('uPa').innerText = atleta.uPago || 'Sin registros';
                    
                    _('sSt').innerText = solvencia.s;
                    _('sSt').className = 'text-xs font-bold px-3 py-1 rounded-full ' + solvencia.c;
                    
                    _('pes').innerText = atleta.peso ? atleta.peso + ' kg' : 'N/A';
                    _('tal').innerText = atleta.talla ? atleta.talla + ' cm' : 'N/A';
                    
                    _('imc').innerText = imcValue > 0 ? imcValue.toFixed(2) : 'N/A';
                    _('iSt').innerText = imcEst.t;
                    _('iSt').className = 'text-[10px] font-bold px-2 py-0.5 rounded uppercase ' + imcEst.c;
                    
                    _('tPr').innerText = proyMetros > 0 ? proyMetros.toFixed(2) + ' m' : 'N/A';

                    _('lM').classList.add('hidden');
                    _('aD').classList.remove('hidden');
                } else {
                    _('lM').innerText = "Atleta no encontrado en el sistema.";
                }
            } catch (e) {
                console.error(e);
                _('lM').innerText = "Error al conectar con la base de datos.";
            }
        };

        onAuthStateChanged(auth, user => {
            const athleteId = getParam('id');
            if (user && athleteId) {
                loadAthleteData(athleteId);
            } else if (!athleteId) {
                _('lM').innerText = "ID de atleta no proporcionado.";
            } else {
                window.location.href = 'index.html';
            }
        });

        window.logout = () => signOut(auth).then(() => location.href = 'index.html');
    </script>
</body>
</html>
