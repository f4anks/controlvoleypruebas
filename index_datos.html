<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Ficha de Atleta - LVMEL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    
    <style>
        /* Estilos personalizados del tema Azul Marino/Eléctrico */
        :root {
            --color-azul-marino: #001F3F;    /* Azul Marino */
            --color-azul-electrico: #0074D9; /* Azul Eléctrico */
            --color-fondo-claro: #f0f8ff;    /* Azure/Azul muy pálido */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-fondo-claro); /* Fondo Azul Pálido */
        }
        .azul-marino-bg { background-color: var(--color-azul-marino); }
        .azul-electrico-text { color: var(--color-azul-electrico); }
        .rounded-xl { border-radius: 0.75rem; }
        .shadow-lg-azul { box-shadow: 0 0 20px -5px rgba(0, 31, 63, 0.4); }
        
        /* Estilo para el BANNER (Altura ajustada a 250px) */
        .banner-header {
            background-image: url('img/banner.png'); 
            background-size: cover; 
            background-position: center; 
            background-repeat: no-repeat;
            min-height: 250px; 
            width: 100%;
        }
        /* Estilo para los títulos de la ficha */
        .data-label {
            font-weight: 600; /* Semibold */
            color: #4b5563; /* Gray-600 */
        }
        /* Estilo para los valores de la ficha */
        .data-value {
            color: #1f2937; /* Gray-800 */
        }
        /* Color de fondo para las métricas físicas y de pago */
        .metric-card {
            background-color: #f7f9fb; /* Light background for metrics */
            border-left: 4px solid var(--color-azul-electrico);
        }
    </style>
</head>
<body>
    
    <div class="banner-header"></div>
    <div class="container mx-auto p-4 md:p-8">
        
        <header class="mb-8 flex flex-col md:flex-row justify-between items-center border-b pb-4">
            <div class="flex items-center space-x-4">
                <a href="index_ficha.html" class="text-gray-600 hover:text-azul-electrico transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 15l-3-3m0 0l3-3m-3 3h8M3 12a9 9 0 1118 0 9 9 0 01-18 0z" />
                    </svg>
                </a>
                <h1 class="text-3xl font-extrabold text-gray-900">
                    Ficha Técnica de <span id="athleteNameTitle" class="azul-electrico-text">Atleta</span>
                </h1>
            </div>
            <button onclick="logout()" class="mt-4 md:mt-0 py-2 px-4 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-200 shadow-md">
                Cerrar Sesión
            </button>
        </header>

        <div id="athleteDataContainer" class="bg-white p-6 rounded-xl shadow-lg-azul">
            <p id="loadingMessage" class="text-center py-10 text-gray-500">Cargando datos del atleta...</p>
            
            <div id="athleteDetail" class="hidden">
                <h2 class="text-2xl font-bold mb-6 border-b pb-2 azul-electrico-text">Información Personal y de Contacto</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-4 mb-8">
                    <div><span class="data-label">Nombre Completo:</span> <span id="nombreApellido" class="data-value"></span></div>
                    <div><span class="data-label">Cédula de Identidad:</span> <span id="cedulaIdentidad" class="data-value"></span></div>
                    <div><span class="data-label">Teléfono:</span> <span id="telefono" class="data-value"></span></div>
                    <div><span class="data-label">Fecha de Nacimiento:</span> <span id="fechaNacimiento" class="data-value"></span></div>
                    <div><span class="data-label">Edad Actual:</span> <span id="edad" class="data-value"></span></div>
                </div>
                
                <h2 class="text-2xl font-bold mb-6 border-b pb-2 azul-electrico-text">Gestión de Pagos</h2>
                <div class="grid grid-cols-1 sm:grid-cols-3 lg:grid-cols-4 gap-6 mb-8">
                    
                    <div class="metric-card p-4 rounded-lg shadow-sm">
                        <p class="data-label text-sm">Nómina Mensual (Bs)</p>
                        <p id="montoPagoMensual" class="text-3xl font-extrabold data-value"></p>
                    </div>

                    <div class="metric-card p-4 rounded-lg shadow-sm">
                        <p class="data-label text-sm">Fecha Último Pago</p>
                        <p id="fechaUltimoPago" class="text-xl font-bold data-value"></p>
                    </div>

                    <div class="metric-card p-4 rounded-lg shadow-sm">
                        <p class="data-label text-sm">Estado de Solvencia</p>
                        <span id="solvencyStatus" class="text-xl font-bold data-value inline-block mt-2 px-2 py-1 leading-none rounded-full"></span>
                    </div>

                </div>

                <h2 class="text-2xl font-bold mb-6 border-b pb-2 azul-electrico-text">Métricas Físicas y Deportivas</h2>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    
                    <div class="metric-card p-4 rounded-lg shadow-sm">
                        <p class="data-label text-sm">Peso (kg)</p>
                        <p id="peso" class="text-3xl font-extrabold data-value"></p>
                    </div>

                    <div class="metric-card p-4 rounded-lg shadow-sm">
                        <p class="data-label text-sm">Talla (m)</p>
                        <p id="talla" class="text-3xl font-extrabold data-value"></p>
                    </div>

                    <div class="metric-card p-4 rounded-lg shadow-sm">
                        <p class="data-label text-sm">Índice de Masa Corporal (IMC)</p>
                        <p id="imc" class="text-3xl font-extrabold data-value"></p>
                        <span id="imcStatus" class="inline-block mt-1 px-2 py-0.5 text-xs font-semibold rounded-full"></span>
                    </div>

                    <div class="metric-card p-4 rounded-lg shadow-sm">
                        <p class="data-label text-sm">Proyección de Talla (m)</p>
                        <p id="tallaProyeccion" class="text-3xl font-extrabold data-value">N/A</p>
                        <span class="inline-block mt-1 px-2 py-0.5 text-xs font-semibold rounded-full bg-green-100 text-green-800">Estimada</span>
                    </div>

                </div>
            </div>
            
        </div>
    </div>

    <script type="module">
        // --- CONSTANTES ---
        const ATHLETES_COLLECTION_NAME = 'club_athletes';

        // --- Importaciones de Firebase ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, doc, getDoc 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; 
        
        // --- Configuración de Firebase ---
        const firebaseConfig = { 
            apiKey: "AIzaSyB5RB7mm1j-0gjCNTUEJTkyEqLjyZ3C7ws",
            authDomain: "datacontrolvoley-ff556.firebaseapp.com",
            projectId: "datacontrolvoley-ff556",
            storageBucket: "datacontrolvoley-ff556.firebasestorage.app",
            messagingSenderId: "516409072606",
            appId: "1:516409072606:web:132538dba358a077d71b4f" 
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Variables de Estado y UI ---
        let athleteId = null;
        const athleteNameTitle = document.getElementById('athleteNameTitle');
        const athleteDetail = document.getElementById('athleteDetail');
        const loadingMessage = document.getElementById('loadingMessage');
        
        
        // ====================================================================
        // === 1. UTILIDADES Y CÁLCULOS =======================================
        // ====================================================================

        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            const results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        function calculateIMC(peso, talla) {
            if (!peso || !talla || talla === 0) return 'N/A';
            const imc = peso / (talla * talla);
            return imc.toFixed(2);
        }

        function getIMCStatus(imc) {
            if (imc === 'N/A' || isNaN(imc)) return { text: 'Sin Datos', class: 'bg-gray-200 text-gray-800' };
            if (imc < 18.5) return { text: 'Bajo Peso', class: 'bg-yellow-100 text-yellow-800' };
            if (imc >= 18.5 && imc <= 24.9) return { text: 'Normal', class: 'bg-green-100 text-green-800' };
            if (imc >= 25 && imc <= 29.9) return { text: 'Sobrepeso', class: 'bg-orange-100 text-orange-800' };
            return { text: 'Obesidad', class: 'bg-red-100 text-red-800' };
        }

        function calculateAge(dateOfBirth) {
            if (!dateOfBirth) return 'N/A';
            const birthDate = new Date(dateOfBirth);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDifference = today.getMonth() - birthDate.getMonth();
            if (monthDifference < 0 || (monthDifference === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return age;
        }

        function calculateTallaProyeccion(talla) {
            if (!talla || talla < 1.0) return 'N/A'; 
            
            // Retorna la talla actual + 5 cm (0.05 m) como una estimación simple y fija.
            const projectedTalla = talla + 0.05; 
            return projectedTalla.toFixed(2);
        }
        
        /**
         * Calcula el estado de solvencia basado en la fecha del último pago.
         * Solvente: Pago dentro de los últimos 30 días.
         * Insolvente: Sin pago registrado o pago mayor a 30 días.
         */
        function calculateSolvencyStatus(fechaUltimoPago) {
            if (!fechaUltimoPago) return { status: 'Insolvente', class: 'bg-red-500 text-white' };

            const lastPaymentDate = new Date(fechaUltimoPago);
            const today = new Date();
            lastPaymentDate.setHours(0, 0, 0, 0);
            today.setHours(0, 0, 0, 0); 
            
            const oneDay = 1000 * 60 * 60 * 24;
            const diffDays = Math.round((today - lastPaymentDate) / oneDay);

            if (diffDays <= 30) {
                return { status: 'Solvente', class: 'bg-green-500 text-white' };
            } else {
                return { status: 'Insolvente', class: 'bg-yellow-500 text-gray-800' };
            }
        }


        // ====================================================================
        // === 2. GESTIÓN DE DATOS ============================================
        // ====================================================================

        async function loadAthleteData(docId) {
            if (!db || !docId) {
                loadingMessage.textContent = "Error: ID de atleta no proporcionado.";
                return;
            }

            try {
                const athleteDocRef = doc(db, ATHLETES_COLLECTION_NAME, docId);
                const docSnap = await getDoc(athleteDocRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // Realizar Cálculos
                    const imc = calculateIMC(data.peso, data.talla);
                    const imcStatus = getIMCStatus(imc);
                    const age = calculateAge(data.fechaNacimiento);
                    const tallaProyeccion = calculateTallaProyeccion(data.talla);
                    const solvency = calculateSolvencyStatus(data.fechaUltimoPago); // <--- NUEVO CÁLCULO
                    
                    // Actualizar Títulos
                    const fullName = data.nombre + " " + data.apellido;
                    athleteNameTitle.textContent = fullName;
                    document.getElementById('pageTitle').textContent = `Ficha de ${fullName}`;

                    // Llenar Datos Personales
                    document.getElementById('nombreApellido').textContent = fullName;
                    document.getElementById('cedulaIdentidad').textContent = data.cedulaIdentidad || 'N/A';
                    document.getElementById('telefono').textContent = data.telefono || 'N/A'; 
                    document.getElementById('fechaNacimiento').textContent = data.fechaNacimiento || 'N/A';
                    document.getElementById('edad').textContent = `${age} años`;
                    
                    // Llenar Datos de Pagos (NUEVO)
                    document.getElementById('montoPagoMensual').textContent = `${(data.montoPagoMensual || 0).toFixed(2)}`;
                    document.getElementById('fechaUltimoPago').textContent = data.fechaUltimoPago || 'No Registrada';
                    document.getElementById('solvencyStatus').textContent = solvency.status;
                    document.getElementById('solvencyStatus').className = `text-xl font-bold data-value inline-block mt-2 px-2 py-1 leading-none rounded-full ${solvency.class}`;

                    // Llenar Métricas Físicas
                    document.getElementById('peso').textContent = `${(data.peso || 0).toFixed(1)} kg`;
                    document.getElementById('talla').textContent = `${(data.talla || 0).toFixed(2)} m`;
                    document.getElementById('imc').textContent = imc;
                    document.getElementById('imcStatus').textContent = imcStatus.text;
                    document.getElementById('imcStatus').className = `inline-block mt-1 px-2 py-0.5 text-xs font-semibold rounded-full ${imcStatus.class}`;
                    document.getElementById('tallaProyeccion').textContent = `${tallaProyeccion} m`;

                    // Mostrar el detalle y ocultar mensaje de carga
                    loadingMessage.classList.add('hidden');
                    athleteDetail.classList.remove('hidden');

                } else {
                    loadingMessage.textContent = "Error: No se encontró ningún atleta con ese ID.";
                }
            } catch (error) {
                console.error("Error al cargar datos del atleta:", error);
                loadingMessage.textContent = `Error al cargar datos. Mensaje: ${error.message}`;
            }
        }


        // ====================================================================
        // === 3. INICIALIZACIÓN Y AUTENTICACIÓN ==============================
        // ====================================================================
        
        async function init() {
            // 1. Obtener ID del atleta de la URL
            athleteId = getUrlParameter('id');

            if (!athleteId) {
                loadingMessage.textContent = "Error: Falta el ID del atleta en la URL.";
                return;
            }

            // 2. Verificar Autenticación (y permisos)
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    loadAthleteData(athleteId);
                } else {
                    window.location.href = 'index.html'; 
                }
            });
        }
        
        init();

        window.logout = async function() {
            try {
                await signOut(auth);
                localStorage.removeItem('currentClub'); 
                window.location.href = 'index.html';
            } catch (error) {
                console.error("Error al cerrar sesión:", error);
            }
        }
        
    </script>

</body>
</html>
