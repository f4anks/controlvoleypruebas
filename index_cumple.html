<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cumplea√±os del Mes - Control Voley</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    
    <style>
        /* Estilos personalizados del tema Azul Marino/El√©ctrico */
        :root {
            --color-azul-marino: #001F3F;    /* Azul Marino */
            --color-azul-electrico: #0074D9; /* Azul El√©ctrico */
            --color-fondo-claro: #f0f8ff;    /* Azure/Azul muy p√°lido */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-fondo-claro); /* Fondo Azul P√°lido */
        }
        .azul-marino-bg { background-color: var(--color-azul-marino); }
        .azul-marino-hover:hover { background-color: #001a33; }
        .azul-electrico-text { color: var(--color-azul-electrico); }
        .rounded-xl { border-radius: 0.75rem; }
        .shadow-lg-azul { box-shadow: 0 0 20px -5px rgba(0, 31, 63, 0.4); }
        
        /* Estilo para el BANNER (Altura ajustada a 250px) */
        .banner-header {
            background-image: url('img/banner.png'); 
            background-size: cover; 
            background-position: center; 
            background-repeat: no-repeat;
            min-height: 250px; 
            width: 100%;
        }
    </style>
</head>
<body>
    
    <div class="banner-header"></div>
    <div class="container mx-auto p-4 md:p-8">
        
        <header class="mb-8 flex flex-col md:flex-row justify-between items-center border-b pb-4">
            <div class="flex items-center space-x-4">
                <a href="index_menu.html" class="text-gray-600 hover:text-azul-electrico transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 15l-3-3m0 0l3-3m-3 3h8M3 12a9 9 0 1118 0 9 9 0 01-18 0z" />
                    </svg>
                </a>
                <h1 class="text-3xl font-extrabold text-gray-900">
                    Cumplea√±os de <span id="currentMonthDisplay" class="azul-electrico-text">Cargando Mes...</span>
                </h1>
            </div>
            <button onclick="logout()" class="mt-4 md:mt-0 py-2 px-4 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-200 shadow-md">
                Cerrar Sesi√≥n
            </button>
        </header>

        <div class="bg-white p-6 rounded-xl shadow-lg-azul overflow-x-auto">
            <h2 id="cumpleTitle" class="text-2xl font-bold mb-4 text-gray-800">Listado de Cumplea√±eros</h2>
            
            <div id="cumpleanosList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <p id="loadingMessage" class="col-span-full text-center py-8 text-gray-500">Cargando lista de cumplea√±os...</p>
            </div>
        </div>

    </div>

    <script type="module">
        // --- CONSTANTES ---
        const ATHLETES_COLLECTION_NAME = 'club_athletes';

        // --- Importaciones de Firebase ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, doc, onSnapshot, query, where, getDoc 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; 
        
        // --- Configuraci√≥n de Firebase ---
        const firebaseConfig = { 
            apiKey: "AIzaSyB5RB7mm1j-0gjCNTUEJTkyEqLjyZ3C7ws",
            authDomain: "datacontrolvoley-ff556.firebaseapp.com",
            projectId: "datacontrolvoley-ff556",
            storageBucket: "datacontrolvoley-ff556.firebasestorage.app",
            messagingSenderId: "516409072606",
            appId: "1:516409072606:web:132538dba358a077d71b4f" 
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Variables de Estado ---
        let teamId = null;
        const currentMonthDisplay = document.getElementById('currentMonthDisplay');
        const cumpleanosList = document.getElementById('cumpleanosList');
        const loadingMessage = document.getElementById('loadingMessage');
        
        
        // ====================================================================
        // === 1. UTILIDADES Y L√ìGICA DE FILTRADO =============================
        // ====================================================================

        /**
         * Busca el Team ID √∫nico al que pertenece el usuario autenticado.
         */
        async function getTeamId(uid) {
            if (!db) return null;
            try {
                const userDocRef = doc(db, "users", uid); 
                const docSnap = await getDoc(userDocRef);

                if (docSnap.exists() && docSnap.data().teamId) {
                    return docSnap.data().teamId;
                }
                return null;
            } catch (error) {
                console.error("Error al obtener el Team ID:", error);
                return null;
            }
        }
        
        /**
         * Determina si el atleta cumple a√±os en el mes actual.
         */
        function isBirthdayThisMonth(dateOfBirth, currentMonth) {
            if (!dateOfBirth) return false;
            
            // Crea un objeto Date. 'T00:00:00' es necesario para evitar problemas de zona horaria.
            const birthMonth = new Date(dateOfBirth + 'T00:00:00').getMonth();
            
            // El mes de Date es 0-indexado (0=Enero, 11=Diciembre)
            return birthMonth === currentMonth; 
        }

        function getMonthName(monthIndex) {
            const months = [
                'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
            ];
            return months[monthIndex];
        }

        function calculateAge(dateOfBirth) {
            if (!dateOfBirth) return 'N/A';
            const birthDate = new Date(dateOfBirth);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDifference = today.getMonth() - birthDate.getMonth();
            if (monthDifference < 0 || (monthDifference === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return age;
        }

        // ====================================================================
        // === 2. GESTI√ìN DE DATOS ============================================
        // ====================================================================

        function loadBirthdays() {
            if (!db || !teamId) {
                console.error("No se pudo iniciar la carga: DB o teamId no disponibles.");
                return;
            }

            // Consulta a Firestore: Trae todos los atletas del club actual
            const q = query(collection(db, ATHLETES_COLLECTION_NAME), where("clubId", "==", teamId));

            const currentMonth = new Date().getMonth();
            currentMonthDisplay.textContent = getMonthName(currentMonth);

            onSnapshot(q, (snapshot) => {
                const birthdays = [];
                snapshot.forEach(doc => {
                    const athlete = { id: doc.id, ...doc.data() };
                    
                    // Filtra por mes en el cliente
                    if (isBirthdayThisMonth(athlete.fechaNacimiento, currentMonth)) {
                        birthdays.push(athlete);
                    }
                });
                renderBirthdays(birthdays);
            }, (error) => {
                console.error("Error al cargar atletas en tiempo real: ", error);
                loadingMessage.textContent = "Error al cargar datos. Verifique la conexi√≥n.";
            });
        }

        function renderBirthdays(birthdays) {
            cumpleanosList.innerHTML = '';
            
            if (birthdays.length === 0) {
                cumpleanosList.innerHTML = `
                    <p class="col-span-full text-center py-8 text-gray-500">
                        üéâ ¬°No hay cumplea√±os registrados para ${currentMonthDisplay.textContent}! üéâ
                    </p>`;
                return;
            }

            // Ordenar por el d√≠a de cumplea√±os
            birthdays.sort((a, b) => {
                const dayA = new Date(a.fechaNacimiento).getDate();
                const dayB = new Date(b.fechaNacimiento).getDate();
                return dayA - dayB;
            });

            birthdays.forEach(athlete => {
                // Se agrega 'T00:00:00' para que JavaScript interprete la fecha sin cambios de zona horaria
                const birthDate = new Date(athlete.fechaNacimiento + 'T00:00:00'); 
                const day = birthDate.getDate();
                const age = calculateAge(athlete.fechaNacimiento);

                const card = `
                    <div class="bg-white border border-yellow-300 p-6 rounded-xl shadow-md flex items-center space-x-4 hover:shadow-lg transition duration-200">
                        <div class="flex-shrink-0 p-3 rounded-full bg-yellow-400 text-white">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M5.5 12.5a1.5 1.5 0 100 3 1.5 1.5 0 000-3zM10 12.5a1.5 1.5 0 100 3 1.5 1.5 0 000-3zM14.5 12.5a1.5 1.5 0 100 3 1.5 1.5 0 000-3z" clip-rule="evenodd" />
                                <path d="M10 2a8 8 0 00-8 8c0 1.255.228 2.478.672 3.619l3.058-2.553a.75.75 0 011.028 1.077L3.6 15.688A7.994 7.994 0 0010 18a8 8 0 008-8h-3a5 5 0 01-5 5V5z" />
                            </svg>
                        </div>
                        
                        <div>
                            <p class="text-xl font-bold azul-electrico-text">${athlete.nombre} ${athlete.apellido}</p>
                            <p class="text-lg font-semibold text-gray-700">D√≠a: <span class="text-red-600">${day}</span></p>
                            <p class="text-sm text-gray-500">Cumple ${age + 1} a√±os</p>
                        </div>
                    </div>
                `;
                cumpleanosList.insertAdjacentHTML('beforeend', card);
            });
        }


        // ====================================================================
        // === 3. INICIALIZACI√ìN Y AUTENTICACI√ìN ==============================
        // ====================================================================
        
        onAuthStateChanged(auth, async (user) => { 
            if (user) {
                const userId = user.uid; 
                
                // OBTENER EL TEAM ID
                teamId = await getTeamId(userId);

                if (teamId) {
                    // Cargar la lista de cumplea√±os usando el Team ID
                    loadBirthdays();
                } else {
                    console.error("No se pudo obtener el Team ID. Redirigiendo.");
                    await signOut(auth);
                    window.location.href = 'index.html'; 
                }

            } else {
                console.log("Sesi√≥n no encontrada. Redirigiendo a index.html");
                window.location.href = 'index.html'; 
            }
        });

        window.logout = async function() {
            try {
                await signOut(auth);
                localStorage.removeItem('currentClub'); 
                window.location.href = 'index.html';
            } catch (error) {
                console.error("Error al cerrar sesi√≥n:", error);
            }
        }
        
    </script>

</body>
</html>
