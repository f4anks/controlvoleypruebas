<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nómina de Atletas - Control Voley</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    
    <style>
        /* Estilos personalizados del tema Azul Marino/Eléctrico */
        :root {
            --color-azul-marino: #001F3F;    /* Azul Marino */
            --color-azul-electrico: #0074D9; /* Azul Eléctrico */
            --color-fondo-claro: #f0f8ff;    /* Azure/Azul muy pálido */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-fondo-claro); /* Fondo Azul Pálido */
        }
        .azul-marino-bg { background-color: var(--color-azul-marino); }
        .azul-electrico-text { color: var(--color-azul-electrico); }
        .rounded-xl { border-radius: 0.75rem; }
        .shadow-lg-azul { box-shadow: 0 0 20px -5px rgba(0, 31, 63, 0.4); }
        .header-bg {
            background-color: var(--color-azul-marino);
        }
        /* Estilo para la tabla */
        .table-header {
            background-color: var(--color-azul-electrico);
            color: white;
        }
    </style>
</head>
<body>
    
    <header class="header-bg text-white shadow-lg">
        <div class="container mx-auto p-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold">Gestión de Nómina <span class="text-yellow-400">Voley</span></h1>
            <nav>
                <a href="index_menu.html" class="px-3 py-1 hover:bg-blue-600 rounded transition duration-200">Menú Principal</a>
                <button onclick="logout()" class="ml-4 px-3 py-1 bg-red-600 hover:bg-red-700 rounded transition duration-200">Cerrar Sesión</button>
            </nav>
        </div>
    </header>

    <div class="container mx-auto p-4 md:p-8">
        
        <section class="mb-10 bg-white p-6 rounded-xl shadow-lg-azul">
            <h2 class="text-2xl font-bold mb-4 border-b pb-2 azul-electrico-text">Registrar / Editar Atleta</h2>
            
            <form id="athleteForm" class="space-y-4">
                <input type="hidden" id="athleteId"> <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div>
                        <label for="nombre" class="block text-sm font-medium text-gray-700">Nombre</label>
                        <input type="text" id="nombre" required 
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="apellido" class="block text-sm font-medium text-gray-700">Apellido</label>
                        <input type="text" id="apellido" required 
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="cedulaIdentidad" class="block text-sm font-medium text-gray-700">Cédula de Identidad</label>
                        <input type="text" id="cedulaIdentidad" required 
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label for="nroCamiseta" class="block text-sm font-medium text-gray-700">Nro Camiseta</label>
                        <input type="number" id="nroCamiseta" name="nroCamiseta" placeholder="Ej: 10" min="0" max="99" 
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="telefono" class="block text-sm font-medium text-gray-700">Teléfono</label>
                        <input type="tel" id="telefono" 
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="fechaNacimiento" class="block text-sm font-medium text-gray-700">Fecha de Nacimiento</label>
                        <input type="date" id="fechaNacimiento" required 
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>

                <h3 class="text-xl font-semibold mt-6 mb-3 border-t pt-4">Métricas y Pagos</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    <div>
                        <label for="peso" class="block text-sm font-medium text-gray-700">Peso (kg)</label>
                        <input type="number" id="peso" step="0.1" 
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="talla" class="block text-sm font-medium text-gray-700">Talla (m)</label>
                        <input type="number" id="talla" step="0.01" 
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="montoPagoMensual" class="block text-sm font-medium text-gray-700">Monto Pago Mensual (Bs)</label>
                        <input type="number" id="montoPagoMensual" step="0.01" 
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="fechaUltimoPago" class="block text-sm font-medium text-gray-700">Fecha Último Pago</label>
                        <input type="date" id="fechaUltimoPago" 
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>

                <div class="flex space-x-4 pt-4">
                    <button type="submit" id="actionButton" 
                        class="py-2 px-4 bg-azul-electrico-text text-white font-semibold rounded-lg hover:bg-blue-600 transition duration-200 shadow-md">
                        Crear Atleta
                    </button>
                    <button type="button" onclick="resetForm()" 
                        class="py-2 px-4 bg-gray-500 text-white font-semibold rounded-lg hover:bg-gray-600 transition duration-200 shadow-md">
                        Limpiar Formulario
                    </button>
                </div>
            </form>
            <p id="message" class="mt-4 text-sm font-medium"></p>
        </section>

        <section class="bg-white p-6 rounded-xl shadow-lg-azul">
            <h2 class="text-2xl font-bold mb-4 border-b pb-2 azul-electrico-text">Listado de Atletas</h2>
            
            <input type="text" id="searchName" placeholder="Buscar por Nombre o Cédula..." 
                class="mb-4 block w-full md:w-1/3 border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="px-6 py-3 table-header text-left text-xs font-medium uppercase tracking-wider">Nombre Completo</th>
                            <th class="px-6 py-3 table-header text-left text-xs font-medium uppercase tracking-wider">Nro Camiseta</th>
                            <th class="px-6 py-3 table-header text-left text-xs font-medium uppercase tracking-wider">Cédula</th>
                            <th class="px-6 py-3 table-header text-left text-xs font-medium uppercase tracking-wider">Edad</th>
                            <th class="px-6 py-3 table-header text-left text-xs font-medium uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="athletesTableBody" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="5" class="p-4 text-center text-gray-500">Cargando atletas...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

    </div>

    <script type="module">
        // --- CONSTANTES ---
        const ATHLETES_COLLECTION_NAME = 'club_athletes';
        const MESSAGE_DURATION = 3000;

        // --- Importaciones de Firebase ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, orderBy, where 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; 
        
        // --- Configuración de Firebase ---
        const firebaseConfig = { 
            apiKey: "AIzaSyB5RB7mm1j-0gjCNTUEJTkyEqLjyZ3C7ws",
            authDomain: "datacontrolvoley-ff556.firebaseapp.com",
            projectId: "datacontrolvoley-ff556",
            storageBucket: "datacontrolvoley-ff556.firebasestorage.app",
            messagingSenderId: "516409072606",
            appId: "1:516409072606:web:132538dba358a077d71b4f" 
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Referencias UI ---
        const athleteForm = document.getElementById('athleteForm');
        const athleteIdField = document.getElementById('athleteId');
        const athletesTableBody = document.getElementById('athletesTableBody');
        const actionButton = document.getElementById('actionButton');
        const messageElement = document.getElementById('message');
        const searchNameInput = document.getElementById('searchName');

        // --- Estado Global ---
        let currentClubCollection = null;


        // ====================================================================
        // === 1. UTILIDADES Y CÁLCULOS =======================================
        // ====================================================================

        function calculateAge(dateOfBirth) {
            if (!dateOfBirth) return 'N/A';
            const birthDate = new Date(dateOfBirth);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDifference = today.getMonth() - birthDate.getMonth();
            if (monthDifference < 0 || (monthDifference === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return age;
        }

        function showMessage(text, isError = false) {
            messageElement.textContent = text;
            messageElement.className = `mt-4 text-sm font-medium ${isError ? 'text-red-600' : 'text-green-600'}`;
            setTimeout(() => {
                messageElement.textContent = '';
                messageElement.className = 'mt-4 text-sm font-medium';
            }, MESSAGE_DURATION);
        }

        function resetForm() {
            athleteForm.reset();
            athleteIdField.value = '';
            // INICIO DEL CAMBIO: Resetear Nro Camiseta
            document.getElementById('nroCamiseta').value = ''; 
            // FIN DEL CAMBIO
            actionButton.textContent = 'Crear Atleta';
            messageElement.textContent = '';
        }


        // ====================================================================
        // === 2. GESTIÓN DE FIREBASE (CRUD) ==================================
        // ====================================================================

        async function saveAthlete(e) {
            e.preventDefault();

            if (!currentClubCollection) {
                showMessage('Error: Club no seleccionado. Intente cerrar sesión e iniciar de nuevo.', true);
                return;
            }

            const isEditing = !!athleteIdField.value;

            // Recoger todos los datos del formulario
            const athleteData = {
                nombre: document.getElementById('nombre').value.trim(),
                apellido: document.getElementById('apellido').value.trim(),
                cedulaIdentidad: document.getElementById('cedulaIdentidad').value.trim(),
                // INICIO DEL CAMBIO: Recoger Nro Camiseta
                nroCamiseta: parseInt(document.getElementById('nroCamiseta').value) || null, // Guardar como número o null
                // FIN DEL CAMBIO
                telefono: document.getElementById('telefono').value.trim(),
                fechaNacimiento: document.getElementById('fechaNacimiento').value,
                peso: parseFloat(document.getElementById('peso').value) || 0,
                talla: parseFloat(document.getElementById('talla').value) || 0,
                montoPagoMensual: parseFloat(document.getElementById('montoPagoMensual').value) || 0,
                fechaUltimoPago: document.getElementById('fechaUltimoPago').value,
                // Campos de registro:
                createdAt: isEditing ? athleteData.createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString(),
            };

            try {
                if (isEditing) {
                    const docRef = doc(db, ATHLETES_COLLECTION_NAME, athleteIdField.value);
                    await updateDoc(docRef, athleteData);
                    showMessage('¡Atleta actualizado con éxito!');
                } else {
                    await addDoc(collection(db, ATHLETES_COLLECTION_NAME), athleteData);
                    showMessage('¡Atleta registrado con éxito!');
                }
                
                resetForm();
                loadAthletes();
            } catch (error) {
                console.error("Error al guardar el atleta:", error);
                showMessage(`Error al guardar: ${error.message}`, true);
            }
        }

        function renderAthletes(athletes) {
            athletesTableBody.innerHTML = ''; 
            if (athletes.length === 0) {
                athletesTableBody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">No se encontraron atletas.</td></tr>';
                return;
            }

            athletes.forEach(athlete => {
                const age = calculateAge(athlete.fechaNacimiento);
                const row = athletesTableBody.insertRow();
                row.className = 'hover:bg-gray-50 transition duration-150';

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        ${athlete.nombre} ${athlete.apellido}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 font-semibold azul-electrico-text">
                        ${athlete.nroCamiseta || 'N/A'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${athlete.cedulaIdentidad || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${age}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editAthlete('${athlete.id}')" class="text-indigo-600 hover:text-indigo-900 mr-4">Editar</button>
                        <button onclick="deleteAthlete('${athlete.id}')" class="text-red-600 hover:text-red-900">Eliminar</button>
                    </td>
                `;
            });
        }
        
        async function loadAthletes() {
            if (!currentClubCollection) return;
            athletesTableBody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">Cargando atletas...</td></tr>';
            
            try {
                // Consulta ordenada por apellido
                const q = query(collection(db, ATHLETES_COLLECTION_NAME), orderBy("apellido"));
                const querySnapshot = await getDocs(q);

                const athletes = [];
                querySnapshot.forEach((doc) => {
                    athletes.push({ id: doc.id, ...doc.data() });
                });

                renderAthletes(athletes);
            } catch (error) {
                console.error("Error al cargar atletas:", error);
                athletesTableBody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-red-500">Error al cargar la nómina.</td></tr>`;
            }
        }
        
        window.editAthlete = function(id) {
            const athleteToEdit = allAthletes.find(a => a.id === id); // Asumiendo que `allAthletes` existe y está actualizado
            if (athleteToEdit) {
                // Llenar el formulario
                athleteIdField.value = id;
                document.getElementById('nombre').value = athleteToEdit.nombre || '';
                document.getElementById('apellido').value = athleteToEdit.apellido || '';
                document.getElementById('cedulaIdentidad').value = athleteToEdit.cedulaIdentidad || '';
                // INICIO DEL CAMBIO: Llenar Nro Camiseta
                document.getElementById('nroCamiseta').value = athleteToEdit.nroCamiseta || '';
                // FIN DEL CAMBIO
                document.getElementById('telefono').value = athleteToEdit.telefono || '';
                document.getElementById('fechaNacimiento').value = athleteToEdit.fechaNacimiento || '';
                document.getElementById('peso').value = athleteToEdit.peso || '';
                document.getElementById('talla').value = athleteToEdit.talla || '';
                document.getElementById('montoPagoMensual').value = athleteToEdit.montoPagoMensual || '';
                document.getElementById('fechaUltimoPago').value = athleteToEdit.fechaUltimoPago || '';

                actionButton.textContent = 'Guardar Cambios';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        };

        window.deleteAthlete = async function(id) {
            if (confirm('¿Estás seguro de que deseas eliminar este atleta? Esta acción es irreversible.')) {
                try {
                    await deleteDoc(doc(db, ATHLETES_COLLECTION_NAME, id));
                    showMessage('Atleta eliminado correctamente.');
                    loadAthletes(); // Recargar la lista
                } catch (error) {
                    console.error("Error al eliminar el atleta:", error);
                    showMessage(`Error al eliminar: ${error.message}`, true);
                }
            }
        };


        // ====================================================================
        // === 3. INICIALIZACIÓN Y AUTENTICACIÓN ==============================
        // ====================================================================
        
        window.logout = async function() {
            try {
                await signOut(auth);
                localStorage.removeItem('currentClub'); 
                window.location.href = 'index.html';
            } catch (error) {
                console.error("Error al cerrar sesión:", error);
            }
        }

        function init() {
            // 1. Manejar la autenticación
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // El usuario está autenticado. Cargar la data.
                    currentClubCollection = ATHLETES_COLLECTION_NAME;
                    loadAthletes();
                } else {
                    // El usuario no está logueado, redirigir a la página de login.
                    window.location.href = 'index.html'; 
                }
            });

            // 2. Asignar listener de guardado/edición
            athleteForm.addEventListener('submit', saveAthlete);

            // 3. Asignar listener de búsqueda
            searchNameInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase().trim();
                // Aquí se asumiría una función de filtrado del lado del cliente o una nueva carga en Firebase
                // Para simplificar, se recomienda implementar el filtrado del lado del cliente en el proyecto real.
                loadAthletes(); // Idealmente sería una función de búsqueda filtrada.
            });
        }
        
        init();
        
    </script>

</body>
</html>
