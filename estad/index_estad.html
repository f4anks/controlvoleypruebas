<!DOCTYPE html>
<html lang="es">
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Voley Stats Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <style>
        :root{
            --color-main-bg:#F7F8FA;
            --color-card-bg:#ffffff;
            --color-text-dark:#1f2937;
            --color-primary-blue:#0056FF;
            --color-secondary-red:#dc2626;
            --color-neutral-orange:#f97316; /* Color para negativo */
            --color-stat-row-bg:#f3f4f6
        }
        body{
            font-family:'Inter',sans-serif;
            user-select:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;
            background-color:var(--color-main-bg)
        }
        .card{
            background-color:var(--color-card-bg);
            color:var(--color-text-dark);
            border:1px solid #d1d5db;
            transition:transform .2s ease-in-out,box-shadow .2s ease-in-out;
            box-shadow:0 4px 10px -1px rgba(0,86,255,.1),0 2px 5px -2px rgba(0,86,255,.05)
        }
        .card:hover{
            transform:translateY(-2px);
            box-shadow:0 8px 15px -3px rgba(0,86,255,.2),0 4px 8px -2px rgba(0,86,255,.1)
        }
        .stat-row-bg{background-color:var(--color-stat-row-bg)}
        .stat-row-text-dark{color:var(--color-text-dark)}
        .score-positive{color:var(--color-primary-blue)}
        .score-negative{color:var(--color-secondary-red)}
        .score-neutral{color:var(--color-neutral-orange)}
        input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}
        input[type=number]{-moz-appearance:textfield}
        input,select{border:1px solid #d1d5db!important;background-color:var(--color-card-bg)!important;color:var(--color-text-dark)!important}
        input:focus,select:focus{box-shadow:0 0 0 2px var(--color-card-bg),0 0 0 4px var(--color-primary-blue)}
        #actionSelect{color:var(--color-text-dark)!important}
        footer{padding:1.5rem 0;text-align:center;width:100%;max-w-5xl;margin-top:2rem;border-top:1px solid #e5e7eb;font-size:.875rem;color:#6b7280}
        footer strong{color:var(--color-text-dark);font-weight:500}
    </style>
</head>

<body class="text-gray-800 min-h-screen flex flex-col items-center p-4">
    <main class="w-full max-w-5xl mx-auto space-y-8 shadow-sm">
        <header class="text-center relative">
            <a href="../index_menu.html" class="absolute top-0 right-0 font-bold py-2 px-4 rounded-md transition-colors text-sm shadow-md" style="background-color: var(--color-primary-blue); color: white;" onmouseover="this.style.backgroundColor='#007bff';" onmouseout="this.style.backgroundColor='var(--color-primary-blue)';" aria-label="Regresar al Menú">Regresar al Menú</a>
            <h1 class="text-4xl font-extrabold tracking-tight stat-row-text-dark sm:text-5xl">Control Voley <span class="text-yellow-600">Stats Tracker</span></h1>
            <p class="mt-4 text-lg text-gray-500 font-medium">Monitorea el rendimiento y la eficiencia de tus atletas en tiempo real.</p>
        </header>

        <div class="grid grid-cols-1 gap-8">
            <div class="space-y-6">
                <div class="card p-6 rounded-lg">
                    <h2 class="text-2xl font-semibold mb-4 pb-2" style="border-bottom: 1px solid var(--color-primary-blue); color: var(--color-primary-blue);">Registrar Atleta</h2>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <input id="playerNumberInput" placeholder="Nro." class="w-full sm:w-24 rounded-md px-3 py-2 focus:outline-none" type="number" style="--tw-ring-color: var(--color-primary-blue);">
                        <input id="playerNameInput" placeholder="Nombre del Atleta" class="flex-grow rounded-md px-3 py-2 focus:outline-none" type="text" style="--tw-ring-color: var(--color-primary-blue);">
                        <button id="addPlayerBtn" class="text-white font-bold py-2 px-4 rounded-md transition-colors shadow-lg" style="background-color: var(--color-primary-blue);" onmouseover="this.style.backgroundColor='#007bff';" onmouseout="this.style.backgroundColor='var(--color-primary-blue)';">Agregar</button>
                    </div>
                </div>

                <div class="card p-6 rounded-lg">
                    <h2 class="text-2xl font-semibold mb-4 pb-2" style="border-bottom: 1px solid var(--color-primary-blue); color: var(--color-primary-blue);">Registrar Acción</h2>
                    <form id="actionForm" class="space-y-4">
                        <div>
                            <label for="playerSelect" class="block mb-2 text-sm font-medium stat-row-text-dark">Seleccionar Atleta</label>
                            <select id="playerSelect" class="w-full rounded-md px-3 py-2 focus:outline-none" style="--tw-ring-color: var(--color-primary-blue);">
                                <option disabled="disabled" selected="selected">Agregar atleta primero</option>
                            </select>
                        </div>
                        <div>
                            <label for="actionSelect" class="block mb-2 text-sm font-medium stat-row-text-dark">Tipo de Acción</label>
                            <select id="actionSelect" class="w-full rounded-md px-3 py-2 focus:outline-none" style="--tw-ring-color: var(--color-primary-blue);"></select>
                        </div>
                        <div class="hidden">
                            <label for="quantityInput" class="block mb-2 text-sm font-medium stat-row-text-dark">Cantidad</label>
                            <input id="quantityInput" value="1" min="1" class="w-full rounded-md px-3 py-2 focus:outline-none" type="number" style="--tw-ring-color: var(--color-primary-blue);">
                        </div>
                        <button type="submit" class="w-full text-white font-bold py-2 px-4 rounded-md transition-colors shadow-lg" style="background-color: var(--color-primary-blue);" onmouseover="this.style.backgroundColor='#007bff';" onmouseout="this.style.backgroundColor='var(--color-primary-blue)';">Registrar</button>
                        <button type="button" id="clearSetDataBtn" class="w-full text-white font-bold py-2 px-4 rounded-md transition-colors mt-4 shadow-md" style="background-color: #d97706;" onmouseover="this.style.backgroundColor='#b45309';" onmouseout="this.style.backgroundColor='#d97706';">Eliminar Datos del Set</button>
                        <button type="button" id="clearGameDataBtn" class="w-full text-white font-bold py-2 px-4 rounded-md transition-colors mt-4 shadow-md" style="background-color: var(--color-secondary-red);" onmouseover="this.style.backgroundColor='#ef4444';" onmouseout="this.style.backgroundColor='var(--color-secondary-red)';">Eliminar Datos del Juego</button>
                    </form>
                </div>
            </div>

            <div class="card p-6 rounded-lg">
                <h2 class="text-2xl font-semibold mb-4 pb-2" style="border-bottom: 1px solid var(--color-primary-blue); color: var(--color-primary-blue);">Estadística por Atleta</h2>
                <div id="scoresContainer" class="space-y-3">
                    <p class="stat-row-text-dark text-center py-8">Aún no hay atletas. ¡Agrégalos para empezar!</p>
                </div>
            </div>

            <div class="card p-6 rounded-lg mt-8">
                <h2 class="text-2xl font-semibold mb-4 pb-2" style="border-bottom: 1px solid var(--color-primary-blue); color: var(--color-primary-blue);">Estadística General por Equipo</h2>
                <div id="generalStatsContainer" class="space-y-3">
                    <p class="stat-row-text-dark text-center py-8">Registra acciones para ver el resumen.</p>
                </div>
            </div>

            <div class="card p-6 rounded-lg mt-8">
                <h2 class="text-2xl font-semibold mb-4 pb-2" style="border-bottom: 1px solid var(--color-primary-blue); color: var(--color-primary-blue);">Gráfica General del Equipo (Positivos vs Negativos - Set Actual)</h2>
                <div class="h-96">
                    <canvas id="barChart"></canvas>
                </div>
            </div>
            
            <div class="card p-6 rounded-lg mt-8">
                <h2 class="text-2xl font-semibold mb-4 pb-2" style="border-bottom: 1px solid var(--color-primary-blue); color: var(--color-primary-blue);">Gráfica de Acciones por Tipo (Acumulado del Juego)</h2>
                <div class="h-96">
                    <canvas id="accumulatedBarChart"></canvas>
                </div>
                <div id="totalPointsSummary" class="text-center mt-4 text-lg font-semibold stat-row-text-dark">
                    </div>
            </div>
        </div>
    </main>

    <footer class="mt-8 text-sm w-full max-w-5xl">
        <p>Copyright © Empresa Sistematikos. Todos los derechos reservados.</p>
        <p>Diseñado por <strong>Sistematikos - Frank Hernandez</strong></p>
    </footer>

    <script>
        let barChartInstance = null;
        let accumulatedBarChartInstance = null; 

        document.addEventListener('DOMContentLoaded', () => {
            const a = document.getElementById('playerNumberInput'),
                b = document.getElementById('playerNameInput'),
                c = document.getElementById('addPlayerBtn'),
                d = document.getElementById('playerSelect'),
                e = document.getElementById('actionSelect'),
                f = document.getElementById('quantityInput'),
                g = document.getElementById('actionForm'),
                h = document.getElementById('scoresContainer'),
                i = document.getElementById('generalStatsContainer'),
                j = document.getElementById('clearSetDataBtn'),
                k = document.getElementById('clearGameDataBtn');
            
            let l = [], // l: players
                m = [], // m: actionLog - Log de acciones del JUEGO COMPLETO (ACUMULADO)
                m_current_set = []; // Log de acciones del SET ACTUAL (Temporal para stats y borrado)

            const n = { // n: scoreMap
                'S# Servicio Positivo': 1, 'A# Ataque Positivo': 1, 'B# Bloqueo Positivo': 1, 
                'R# Recepción Positiva': 1, 'C# Coloque Positivo': 1, 'D# Defensa Positiva': 1,
                'S= Servicio Negativo': -1, 'A= Ataque Negativo': -1, 'B= Bloqueo Negativo': -1, 
                'R= Recepción Negativo': -1, 'C= Coloque Negativo': -1, 'D= Defensa Negativa': -1
            },
            o = { // o: actionTypes (solo las letras iniciales)
                S: 'Servicio', A: 'Ataque', B: 'Bloqueo', R: 'Recepción', C: 'Coloque', D: 'Defensa'
            },
            p = { // p: colorMap
                primaryBlue: '#0056FF', 
                secondaryRed: '#dc2626', 
                textDark: '#1f2937', 
                cardBg: '#ffffff',
                neutralOrange: '#f97316', // Usaremos este color para negativos
                successGreen: '#10b981'
            };

            // ----------------------------------------------------------------------
            // FUNCIONES PRINCIPALES
            // ----------------------------------------------------------------------

            // Guarda datos en localStorage
            function q() {
                localStorage.setItem('volleyballPlayers', JSON.stringify(l));
                localStorage.setItem('volleyballActionLog', JSON.stringify(m)); 
                localStorage.setItem('volleyballCurrentSetLog', JSON.stringify(m_current_set)); 
            }
            
            // Carga datos desde localStorage
            function r() {
                const a = localStorage.getItem('volleyballPlayers');
                a && (l = JSON.parse(a));
                const b = localStorage.getItem('volleyballActionLog');
                b && (m = JSON.parse(b));
                const setLog = localStorage.getItem('volleyballCurrentSetLog');
                setLog && (m_current_set = JSON.parse(setLog));
            }

            // Actualiza el estilo del select de acción
            function s() {
                const a = e.options[e.selectedIndex],
                    b = a ? a.value : null,
                    c = b ? n[b] : 0;
                c > 0 ? e.style.borderColor = p.primaryBlue : c < 0 ? e.style.borderColor = p.secondaryRed : e.style.borderColor = '#d1d5db';
                return c;
            }

            // Llena el select de atletas (d)
            function populatePlayerSelect() {
                d.innerHTML = '';
                if (l.length === 0) {
                    d.innerHTML = '<option disabled selected>Agregar atleta primero</option>';
                    return;
                }
                l.sort((p1, p2) => p1.number - p2.number);
                l.forEach(player => {
                    const option = document.createElement('option');
                    option.value = player.number;
                    option.textContent = `#${player.number} - ${player.name}`;
                    d.appendChild(option);
                });
            }

            // Llena el select de acciones (e)
            function populateActionSelect() {
                e.innerHTML = '';
                Object.keys(n).forEach(action => {
                    const option = document.createElement('option');
                    option.value = action;
                    option.textContent = action;
                    e.appendChild(option);
                });
                s(); // Establecer color inicial
            }
            
            // ----------------------------------------------------------------------
            // FUNCIONES DE ESTADÍSTICA
            // ----------------------------------------------------------------------
            
            // 1. Estadísticas por Atleta (h) - Usa m_current_set
            function updateScoreContainer() {
                h.innerHTML = ''; 
                if (l.length === 0) {
                    h.innerHTML = '<p class="stat-row-text-dark text-center py-8">Aún no hay atletas. ¡Agrégalos para empezar!</p>';
                    return;
                }
                
                const playerStats = {};
                l.forEach(player => {
                    playerStats[player.number] = { totalPos: 0, totalNeg: 0, efficiency: 0, differential: 0, totalActions: 0, actions: {} };
                });

                m_current_set.forEach(log => {
                    const stats = playerStats[log.playerNumber];
                    const score = n[log.action];
                    const quantity = log.quantity || 1;
                    const actionType = log.action.charAt(0); 

                    if (stats) {
                        stats.totalActions += quantity; // Suma todas las acciones (Pos o Neg)
                        if (score > 0) stats.totalPos += quantity;
                        else if (score < 0) stats.totalNeg += quantity;

                        if (!stats.actions[actionType]) stats.actions[actionType] = { pos: 0, neg: 0 };
                        if (score > 0) stats.actions[actionType].pos += quantity;
                        else if (score < 0) stats.actions[actionType].neg += quantity;
                    }
                });
                
                l.sort((p1, p2) => p1.number - p2.number);
                l.forEach(player => {
                    const stats = playerStats[player.number];
                    const totalActions = stats.totalPos + stats.totalNeg;
                    stats.differential = stats.totalPos - stats.totalNeg; // Diferencial Pos - Neg
                    stats.efficiency = totalActions > 0 ? (stats.differential / totalActions) * 100 : 0;
                    
                    let actionDetails = '';
                    Object.keys(o).forEach(key => {
                        const typeStats = stats.actions[key];
                        if (typeStats) {
                            actionDetails += `<span class="text-sm font-medium mr-3">${key}: <span class="score-positive">${typeStats.pos}</span> | <span class="score-neutral" style="color: ${p.neutralOrange};">${typeStats.neg}</span></span>`;
                        }
                    });

                    // Determinamos el color para el diferencial neto
                    const differentialColor = stats.differential > 0 ? p.successGreen : (stats.differential < 0 ? p.secondaryRed : p.textDark);

                    h.innerHTML += `
                        <div class="stat-row-bg p-3 rounded-lg flex flex-col shadow-sm">
                            <div class="flex justify-between items-center mb-2">
                                <div class="font-bold text-lg stat-row-text-dark">#${player.number} ${player.name}</div>
                                <div class="text-right">
                                    <span class="font-bold text-xl" style="color: ${stats.efficiency >= 0 ? p.successGreen : p.secondaryRed};">
                                        ${stats.efficiency.toFixed(1)}%
                                    </span>
                                </div>
                            </div>

                            <div class="flex justify-between text-sm py-1 border-b border-gray-300">
                                <span class="font-semibold stat-row-text-dark">Acciones por tipo:</span>
                                <div class="text-xs">${actionDetails || 'Sin acciones en este Set.'}</div>
                            </div>
                            
                            <div class="flex justify-between text-sm py-1 border-b border-gray-300">
                                <span class="font-semibold stat-row-text-dark">Total de Acciones:</span>
                                <span class="font-semibold stat-row-text-dark">${stats.totalActions}</span>
                            </div>

                            <div class="flex justify-between text-base pt-2">
                                <span class="font-bold stat-row-text-dark">Diferencial Neto (P-N):</span>
                                <span class="font-extrabold" style="color: ${differentialColor};">
                                    ${stats.differential > 0 ? '+' : ''}${stats.differential}
                                </span>
                            </div>
                        </div>
                    `;
                });
            }

            // 2. Estadística General por Equipo (i) - Usa m_current_set
            function updateGeneralStats() {
                i.innerHTML = '';
                if (m_current_set.length === 0) {
                    i.innerHTML = '<p class="stat-row-text-dark text-center py-8">Registra acciones para ver el resumen.</p>';
                    return;
                }
                
                const teamStats = {};
                let totalActions = 0;
                let teamPos = 0;
                let teamNeg = 0;

                m_current_set.forEach(log => {
                    const score = n[log.action];
                    const quantity = log.quantity || 1;
                    const actionType = log.action.charAt(0);

                    if (!teamStats[actionType]) teamStats[actionType] = { pos: 0, neg: 0 };
                    
                    if (score > 0) {
                        teamStats[actionType].pos += quantity;
                        teamPos += quantity;
                    } else if (score < 0) {
                        teamStats[actionType].neg += quantity;
                        teamNeg += quantity;
                    }
                    totalActions += quantity;
                });
                
                const totalEfficiency = totalActions > 0 ? ((teamPos - teamNeg) / totalActions) * 100 : 0;

                let statsHtml = `
                    <div class="flex justify-between items-center stat-row-bg p-3 rounded-lg font-bold">
                        <span>Eficiencia Total del Equipo:</span>
                        <span class="text-xl" style="color: ${totalEfficiency >= 0 ? p.successGreen : p.secondaryRed};">${totalEfficiency.toFixed(1)}%</span>
                    </div>
                `;

                Object.keys(o).forEach(key => {
                    const stats = teamStats[key];
                    if (stats) {
                        const typeTotal = stats.pos + stats.neg;
                        const typeEfficiency = typeTotal > 0 ? ((stats.pos - stats.neg) / typeTotal) * 100 : 0;
                        statsHtml += `
                            <div class="p-3 border-b border-gray-200 flex justify-between stat-row-text-dark">
                                <span>${o[key]} (${typeTotal} acciones):</span>
                                <span><span class="score-positive">${stats.pos}</span> | <span class="score-neutral" style="color: ${p.neutralOrange};">${stats.neg}</span> | 
                                    <span class="font-medium" style="color: ${typeEfficiency >= 0 ? p.primaryBlue : p.secondaryRed};">${typeEfficiency.toFixed(0)}%</span>
                                </span>
                            </div>
                        `;
                    }
                });
                
                i.innerHTML = statsHtml;
            }

            // 3. Gráfica de Barras (barChart) - Usa m_current_set (Barras Agrupadas, Set Actual)
            function updateBarChart() {
                const actionTotals = {};
                Object.keys(o).forEach(key => actionTotals[key] = { pos: 0, neg: 0 });

                m_current_set.forEach(log => {
                    const score = n[log.action];
                    const quantity = log.quantity || 1;
                    const actionType = log.action.charAt(0);
                    
                    if (actionTotals[actionType]) {
                        if (score > 0) actionTotals[actionType].pos += quantity;
                        else if (score < 0) actionTotals[actionType].neg += quantity;
                    }
                });
                
                const labels = Object.values(o);
                const positiveData = labels.map(label => actionTotals[Object.keys(o).find(key => o[key] === label)]?.pos || 0);
                const negativeData = labels.map(label => actionTotals[Object.keys(o).find(key => o[key] === label)]?.neg || 0);

                if (barChartInstance) barChartInstance.destroy();

                const ctx = document.getElementById('barChart').getContext('2d');
                barChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Acciones Positivas',
                                data: positiveData,
                                backgroundColor: p.primaryBlue,
                                barPercentage: 0.8, 
                                categoryPercentage: 0.9 
                            },
                            {
                                label: 'Acciones Negativas',
                                data: negativeData,
                                backgroundColor: p.neutralOrange, 
                                barPercentage: 0.8,
                                categoryPercentage: 0.9
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { stacked: false },
                            y: { 
                                stacked: false, 
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1, 
                                    callback: function(value) {
                                        if (Number.isInteger(value)) {
                                            return value;
                                        }
                                    }
                                } 
                            }
                        }
                    }
                });
            }


            // 4. Gráfica de Barras Acumuladas (TOTALES POR ACCIÓN) - Usa m (Log de Juego Completo)
            function updateAccumulatedBarChart() {
                const actionTotals = {};
                let totalPositive = 0;
                let totalNegative = 0;

                Object.keys(o).forEach(key => actionTotals[key] = { pos: 0, neg: 0 });

                // USAMOS EL LOG COMPLETO (m)
                m.forEach(log => {
                    const score = n[log.action];
                    const quantity = log.quantity || 1;
                    const actionType = log.action.charAt(0);
                    
                    if (actionTotals[actionType]) {
                        if (score > 0) {
                            actionTotals[actionType].pos += quantity;
                            totalPositive += quantity;
                        } else if (score < 0) {
                            actionTotals[actionType].neg += quantity;
                            totalNegative += quantity;
                        }
                    }
                });
                
                const labels = Object.values(o);
                const positiveData = labels.map(label => actionTotals[Object.keys(o).find(key => o[key] === label)]?.pos || 0);
                const negativeData = labels.map(label => actionTotals[Object.keys(o).find(key => o[key] === label)]?.neg || 0);

                const totalActions = totalPositive + totalNegative;
                const ctx = document.getElementById('accumulatedBarChart').getContext('2d');
                const summaryDiv = document.getElementById('totalPointsSummary');
                const chartContainer = document.getElementById('accumulatedBarChart');

                if (totalActions === 0) {
                    summaryDiv.innerHTML = 'No se han registrado acciones aún para las gráficas generales.';
                    chartContainer.style.display = 'none';
                    if (accumulatedBarChartInstance) {
                        accumulatedBarChartInstance.destroy();
                        accumulatedBarChartInstance = null;
                    }
                    return;
                }

                chartContainer.style.display = 'block';

                summaryDiv.innerHTML = `
                    <p class="score-positive">Puntos Positivos Acumulados: ${totalPositive}</p>
                    <p class="score-neutral" style="color: ${p.neutralOrange};">Puntos Negativos Acumulados: ${totalNegative}</p>
                    <p class="stat-row-text-dark">Total de Acciones con Valor: ${totalActions}</p>
                `;

                if (accumulatedBarChartInstance) {
                    accumulatedBarChartInstance.destroy();
                }
                
                // Creamos la gráfica de barras detallada
                accumulatedBarChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels, 
                        datasets: [
                            {
                                label: 'Acciones Positivas Acumuladas',
                                data: positiveData,
                                backgroundColor: p.primaryBlue,
                                barPercentage: 0.8, 
                                categoryPercentage: 0.9
                            },
                            {
                                label: 'Acciones Negativas Acumuladas',
                                data: negativeData,
                                backgroundColor: p.neutralOrange, 
                                barPercentage: 0.8,
                                categoryPercentage: 0.9
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { stacked: false },
                            y: { 
                                stacked: false, 
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1, 
                                    callback: function(value) {
                                        if (Number.isInteger(value)) {
                                            return value;
                                        }
                                    }
                                } 
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { color: p.textDark, font: { size: 14, family: 'Inter' } }
                            },
                            title: {
                                display: false 
                            }
                        }
                    }
                });
            }


            // FUNCIÓN MAESTRA PARA ACTUALIZAR TODO
            function updateAllStats() {
                // Actualiza las estadísticas del SET ACTUAL
                updateScoreContainer();
                updateGeneralStats();
                updateBarChart();
                
                // Actualiza las estadísticas ACUMULADAS del JUEGO
                updateAccumulatedBarChart();
            }
            
            // ----------------------------------------------------------------------
            // MANEJADORES DE EVENTOS
            // ----------------------------------------------------------------------

            // Manejador para agregar atleta
            c.addEventListener('click', () => {
                const number = parseInt(a.value.trim());
                const name = b.value.trim();

                if (isNaN(number) || number <= 0 || name === '') {
                    alert('Por favor, ingresa un número y nombre de atleta válidos.');
                    return;
                }
                if (l.some(player => player.number === number)) {
                    alert(`El número ${number} ya está asignado a un atleta.`);
                    a.focus();
                    return;
                }

                l.push({ number: number, name: name });
                q(); 
                populatePlayerSelect(); 
                updateAllStats();
                
                a.value = '';
                b.value = '';
                alert(`Atleta #${number} (${name}) agregado con éxito.`);
            });

            // Manejador para cambiar el color del select de acción al seleccionar
            e.addEventListener('change', s);

            // Manejador para registrar acción
            g.addEventListener('submit', (event) => {
                event.preventDefault();
                const playerNumber = parseInt(d.value);
                const action = e.value;
                const quantity = parseInt(f.value) || 1;

                if (!playerNumber) {
                    alert('Por favor, selecciona un atleta.');
                    return;
                }
                
                const logEntry = {
                    playerNumber: playerNumber,
                    action: action,
                    quantity: quantity,
                    timestamp: new Date().toISOString()
                };

                // Registra la acción en ambos logs
                m.push(logEntry); // Log Acumulado (Juego)
                m_current_set.push(logEntry); // Log Temporal (Set Actual)

                q(); 
                updateAllStats(); 

                alert(`Acción registrada: #${playerNumber} - ${action} (x${quantity})`);
            });


            // Manejador para el botón "Eliminar Datos del Set" (SOLO BORRA M_CURRENT_SET)
            j.addEventListener('click', () => {
                if (confirm('¿Estás seguro de que deseas ELIMINAR los datos del SET? (Solo se borran las acciones del set actual, el acumulado del juego se mantiene)')) {
                    m_current_set = []; // Borrar solo el log del set actual
                    q(); 
                    alert('Datos del set eliminados. El acumulado del juego se ha conservado.');
                    updateAllStats(); 
                }
            });

            // Manejador para el botón "Eliminar Datos del Juego" (BORRA TODO)
            k.addEventListener('click', () => {
                if (confirm('¿Estás seguro de que deseas ELIMINAR TODOS los datos del JUEGO (log de acciones y jugadores)? Esta acción es irreversible.')) {
                    l = []; // Borrar jugadores
                    m = []; // Borrar log de juego
                    m_current_set = []; // Borrar log del set
                    q(); 
                    window.location.reload(); 
                }
            });


            // ----------------------------------------------------------------------
            // INICIALIZACIÓN
            // ----------------------------------------------------------------------
            
            r(); // Cargar datos
            populateActionSelect(); 
            populatePlayerSelect(); 
            updateAllStats(); 

        });
    </script>
</body>
</html>
