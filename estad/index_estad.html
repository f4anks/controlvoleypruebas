<!DOCTYPE html>
<html lang="es">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Voley Stats Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap"
      rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

    <style>
      /* --- Colores de la paleta Control Voley --- */
      :root {
        /* *** CAMBIO CLAVE: De Azul a Gris/Negro Oscuro Profesional *** */
        --color-main-bg: #14171A; /* Gris/Negro Oscuro (Fondo General) */
        /* ************************************************************ */
        
        --color-card-bg: #ffffff; /* Blanco Puro (Fondo de Tarjeta) */
        --color-text-dark: #1f2937; /* Gris Oscuro (Texto Principal sobre fondo claro) */
        --color-primary-blue: #0056FF; /* Azul Eléctrico Brillante (Acción/Foco/Positivo) */
        --color-secondary-red: #dc2626; /* Rojo (Negativo) */
        --color-neutral-orange: #f97316; /* Naranja/Ámbar (Neutral/Puntos) */
        --color-stat-row-bg: #f3f4f6; /* Gris Muy Claro (Fondo Filas de Estadísticas) */
      }

      body {
        font-family: 'Inter', sans-serif;
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        background-color: var(--color-main-bg); 
      }
      .card {
        background-color: var(--color-card-bg); 
        color: var(--color-text-dark); /* Texto oscuro para el contenido de la tarjeta */
        border: 1px solid #d1d5db;
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        /* Sombra Azul para destacar la interactividad */
        box-shadow: 0 4px 10px -1px rgba(0, 86, 255, 0.4), 0 2px 5px -2px rgba(0, 86, 255, 0.2);
      }
      .card:hover {
        transform: translateY(-4px);
        /* Sombra más intensa en hover */
        box-shadow: 0 12px 20px -5px rgba(0, 86, 255, 0.6), 0 5px 10px -3px rgba(0, 86, 255, 0.4);
      }
      
      /* Filas de Estadística con fondo CLARO */
      .stat-row-bg {
        background-color: var(--color-stat-row-bg); 
      }
      .stat-row-text-dark {
        color: var(--color-text-dark); 
      }
      
      /* COLORES DE PUNTUACIÓN (Usados en texto y en JS para Chart) */
      .score-positive { color: var(--color-primary-blue); }	
      .score-negative { color: var(--color-secondary-red); }	
      .score-neutral { color: var(--color-neutral-orange); }	

      /* Ocultar flechas de input type=number */
      input[type=number]::-webkit-inner-spin-button,
      input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      input[type=number] {
        -moz-appearance: textfield;
      }
      
      /* Campos de input/select (Asegura fondo claro y texto oscuro) */
      input, select {
          border: 1px solid #d1d5db !important;
          background-color: var(--color-card-bg) !important;
          color: var(--color-text-dark) !important;
      }
      
      input:focus, select:focus {
        /* Foco Azul Eléctrico */
        box-shadow: 0 0 0 2px var(--color-card-bg), 0 0 0 4px var(--color-primary-blue);
      }
      
      /* Texto de selects dinámico (se sobreescribe con JS para el color de puntuación) */
      #actionSelect {
        color: var(--color-text-dark) !important; 
      }
      
      /* Estilo básico para el footer (manteniendo el color oscuro sobre el fondo azul) */
      footer {
        padding: 1.5rem 0;
        text-align: center;
        width: 100%;
        max-width: 5xl;
        margin-top: 2rem;
        /* El borde azul eléctrico sigue siendo el elemento de contraste del sistema */
        border-top: 1px solid var(--color-primary-blue); 
        font-size: 0.875rem; 
        color: #9ca3af; /* Texto claro ligeramente más oscuro */
      }
      footer strong {
        color: var(--color-card-bg); 
        font-weight: 500;
      }
    </style>
  </head>

  <body class="text-gray-200 min-h-screen flex flex-col items-center p-4">
    <main class="w-full max-w-5xl mx-auto space-y-8 shadow-2xl">
      <header class="text-center relative text-white">
        <a href="../index_menu.html" class="absolute top-0 right-0 font-bold py-2 px-4 rounded-md transition-colors text-sm shadow-md" 
        style="background-color: var(--color-primary-blue); color: white;" 
        onmouseover="this.style.backgroundColor='#007bff';" onmouseout="this.style.backgroundColor='var(--color-primary-blue)';" 
        aria-label="Regresar al Menú">
          Regresar al Menú
        </a>

        <h1 class="text-4xl font-extrabold tracking-tight text-white sm:text-5xl">Control Voley <span class="text-yellow-400">Stats Tracker</span></h1>
        <p class="mt-4 text-lg text-gray-200 font-medium">Monitorea el rendimiento y la
          eficiencia de tus atletas en tiempo real.</p>
      </header>
      
      <div class="grid grid-cols-1 gap-8">
        <div class="space-y-6">
          <div class="card p-6 rounded-lg">
            <h2 class="text-2xl font-semibold mb-4 pb-2" style="border-bottom: 1px solid var(--color-primary-blue); color: var(--color-primary-blue);">Registrar Atleta</h2>
            <div class="flex flex-col sm:flex-row gap-4">	
              <input id="playerNumberInput" placeholder="Nro."	
                class="w-full sm:w-24 rounded-md px-3 py-2 focus:outline-none"
                type="number" style="--tw-ring-color: var(--color-primary-blue);">	
              <input id="playerNameInput" placeholder="Nombre del Atleta"
                class="flex-grow rounded-md px-3 py-2 focus:outline-none"
                type="text" style="--tw-ring-color: var(--color-primary-blue);">	
              <button id="addPlayerBtn" class="text-white font-bold py-2 px-4 rounded-md transition-colors shadow-lg"
              style="background-color: var(--color-primary-blue);"
              onmouseover="this.style.backgroundColor='#007bff';" onmouseout="this.style.backgroundColor='var(--color-primary-blue)';">
                Agregar	
              </button>	
            </div>
          </div>
          
          <div class="card p-6 rounded-lg">
            <h2 class="text-2xl font-semibold mb-4 pb-2" style="border-bottom: 1px solid var(--color-primary-blue); color: var(--color-primary-blue);">Registrar
              Acción</h2>
            <form id="actionForm" class="space-y-4">
              <div>	
                <label for="playerSelect" class="block mb-2 text-sm font-medium stat-row-text-dark">Seleccionar
                  Atleta</label>
                <select id="playerSelect" class="w-full rounded-md px-3 py-2 focus:outline-none" style="--tw-ring-color: var(--color-primary-blue);">
                  <option disabled="disabled" selected="selected">Agregar atleta
                    primero</option>
                </select>
              </div>
              <div>	
                <label for="actionSelect" class="block mb-2 text-sm font-medium stat-row-text-dark">Tipo
                  de Acción</label>
                <select id="actionSelect" class="w-full rounded-md px-3 py-2 focus:outline-none" style="--tw-ring-color: var(--color-primary-blue);">
                </select>
              </div>
              <div class="hidden">	
                <label for="quantityInput" class="block mb-2 text-sm font-medium stat-row-text-dark">Cantidad</label>
                <input id="quantityInput" value="1" min="1"	
                  class="w-full rounded-md px-3 py-2 focus:outline-none"
                  type="number" style="--tw-ring-color: var(--color-primary-blue);">	
              </div>
              
              <button type="submit" class="w-full text-white font-bold py-2 px-4 rounded-md transition-colors shadow-lg"
              style="background-color: var(--color-primary-blue);"
              onmouseover="this.style.backgroundColor='#007bff';" onmouseout="this.style.backgroundColor='var(--color-primary-blue)';">
                Registrar	
              </button>	
              
              <button type="button" id="clearSetDataBtn" class="w-full text-white font-bold py-2 px-4 rounded-md transition-colors mt-4 shadow-md"
              style="background-color: #d97706;"
              onmouseover="this.style.backgroundColor='#b45309';" onmouseout="this.style.backgroundColor='#d97706';">
                Eliminar Datos del Set	
              </button>	

              <button type="button" id="clearGameDataBtn" class="w-full text-white font-bold py-2 px-4 rounded-md transition-colors mt-4 shadow-md"
              style="background-color: var(--color-secondary-red);"
              onmouseover="this.style.backgroundColor='#ef4444';" onmouseout="this.style.backgroundColor='var(--color-secondary-red)';">
                Eliminar Datos del Juego	
              </button>	
            </form>
          </div>
        </div>
        
        <div class="card p-6 rounded-lg">
          <h2 class="text-2xl font-semibold mb-4 pb-2" style="border-bottom: 1px solid var(--color-primary-blue); color: var(--color-primary-blue);">Estadística por Atleta</h2>
          <div id="scoresContainer" class="space-y-3">
            <p class="stat-row-text-dark text-center py-8">Aún no hay atletas.
              ¡Agrégalos para empezar!</p>
          </div>
        </div>
        
        <div class="card p-6 rounded-lg mt-8">
            <h2 class="text-2xl font-semibold mb-4 pb-2" style="border-bottom: 1px solid var(--color-primary-blue); color: var(--color-primary-blue);">Estadística General por Equipo</h2>
            <div id="generalStatsContainer" class="space-y-3">
              <p class="stat-row-text-dark text-center py-8">Registra acciones para ver el resumen.</p>
            </div>
        </div>
        
        <div class="card p-6 rounded-lg mt-8">
            <h2 class="text-2xl font-semibold mb-4 pb-2" style="border-bottom: 1px solid var(--color-primary-blue); color: var(--color-primary-blue);">Gráfica General del Equipo (Positivos vs Negativos)</h2>
            <div class="h-96">
                <canvas id="barChart"></canvas>
            </div>
        </div>
        
      </div>
    </main>

    <footer class="mt-8 text-sm w-full max-w-5xl">
        <p>Copyright © Empresa Sistematikos. Todos los derechos reservados.</p>
        <p>Diseñado por <strong>Sistematikos - Frank Hernandez</strong></p>
    </footer>

    <script>
      let barChartInstance = null; // Variable para mantener la instancia del gráfico

      document.addEventListener('DOMContentLoaded', () => {
        // --- Referencias a Elementos DOM ---
        const playerNumberInput = document.getElementById('playerNumberInput');
        const playerNameInput = document.getElementById('playerNameInput');
        const addPlayerBtn = document.getElementById('addPlayerBtn');
        const playerSelect = document.getElementById('playerSelect');
        const actionSelect = document.getElementById('actionSelect');
        const quantityInput = document.getElementById('quantityInput');
        const actionForm = document.getElementById('actionForm');
        const scoresContainer = document.getElementById('scoresContainer');
        const generalStatsContainer = document.getElementById('generalStatsContainer');	
        
        const clearSetDataBtn = document.getElementById('clearSetDataBtn');	
        const clearGameDataBtn = document.getElementById('clearGameDataBtn');	

        let players = [];
        let actionLog = [];	

        // Acciones Positivas (+1) y Negativas (-1)
        const actions = {
          'S# Servicio Positivo': 1, 'A# Ataque Positivo': 1, 'B# Bloqueo Positivo': 1, 'R# Recepción Positiva': 1, 'C# Coloque Positivo': 1, 'D# Defensa Positiva': 1,	
          'S= Servicio Negativo': -1, 'A= Ataque Negativo': -1, 'B= Bloqueo Negativo': -1, 'R= Recepción Negativo': -1, 'C= Coloque Negativo': -1, 'D= Defensa Negativa': -1,	
        };
        
        // Mapeo para agrupar por tipo (ej: S# y S= se agrupan en "Servicio")
        const actionGroups = {
          'S': 'Servicio',
          'A': 'Ataque',
          'B': 'Bloqueo',
          'R': 'Recepción',
          'C': 'Coloque',
          'D': 'Defensa'
        };

        // Colores definidos en CSS (para uso en JS/Chart.js)
        const COLORS = {
            primaryBlue: '#0056FF',
            secondaryRed: '#dc2626',
            textDark: '#1f2937'
        };

        // Funciones de LocalStorage
        function savePlayers() {
          localStorage.setItem('volleyballPlayers', JSON.stringify(players));
          localStorage.setItem('volleyballActionLog', JSON.stringify(actionLog));
        }
        function loadPlayers() {
          const storedPlayers = localStorage.getItem('volleyballPlayers');
          if (storedPlayers) {
            players = JSON.parse(storedPlayers);
          }
          const storedActionLog = localStorage.getItem('volleyballActionLog');
          if (storedActionLog) {
            actionLog = JSON.parse(storedActionLog);
          }
        }
        
        loadPlayers();

        function setActionSelectColor() {
          const selectedOption = actionSelect.options[actionSelect.selectedIndex];
          const actionName = selectedOption ? selectedOption.value : null;
          const actionValue = actionName ? actions[actionName] : 0;	

          if (actionValue > 0) {
            // Azul Eléctrico
            actionSelect.style.color = COLORS.primaryBlue;	
          } else if (actionValue < 0) {
            actionSelect.style.color = COLORS.secondaryRed;
          } else {
            actionSelect.style.color = '#f97316'; /* Naranja */
          }
        }

        function populateActions() {
          actionSelect.innerHTML = '';
          
          const sortedActions = Object.keys(actions).sort((a, b) => {
            return actions[b] - actions[a];	
          });

          sortedActions.forEach(actionName => {
            const option = document.createElement('option');
            const value = actions[actionName];
            option.value = actionName;
            
            // --- MODIFICACIÓN PARA AÑADIR ESPACIO VISUAL ---
            // Uso de '\u00A0' (Non-breaking space) para asegurar la separación horizontal
            const code = actionName.substring(0, 2); // Ejemplo: 'S#'
            const name = actionName.substring(3);	 	// Ejemplo: 'Servicio Positivo'
            const scoreDisplay = `(${value > 0 ? '+' : ''}${value})`;
            
            // Se aumenta el espacio entre código y nombre, y entre nombre y puntuación
            option.textContent = `${code}${'\u00A0'.repeat(7)}${name}${'\u00A0'.repeat(5)}${scoreDisplay}`;
            
            if (value > 0) {
              // Azul Eléctrico
              option.style.color = COLORS.primaryBlue;	
            } else if (value < 0) {
              option.style.color = COLORS.secondaryRed;
            } else {	
              option.style.color = '#f97316'; /* Naranja */
            }
            actionSelect.appendChild(option);
          });
          setActionSelectColor();	
        }

        // --- FUNCIÓN PARA RENDERIZAR EL GRÁFICO DE BARRAS DOBLES ---
        function renderBarChart(chartData) {
          const ctx = document.getElementById('barChart').getContext('2d');
          
          if (barChartInstance) {
            barChartInstance.destroy();
          }
          
          if (!chartData || chartData.labels.length === 0) {
            return;
          }
          
          barChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: chartData.labels,
              datasets: [
                {
                  label: 'Acciones Positivas',
                  data: chartData.positiveData,
                  // Azul Eléctrico para positivos
                  backgroundColor: 'rgba(0, 86, 255, 0.9)',	
                  borderColor: 'rgba(0, 86, 255, 1)',
                  borderWidth: 1,
                  barThickness: 15,	
                  maxBarThickness: 20
                },
                {
                  label: 'Acciones Negativas',
                  data: chartData.negativeData,
                  // Rojo para negativos
                  backgroundColor: 'rgba(220, 38, 38, 0.9)',	
                  borderColor: 'rgba(220, 38, 38, 1)',
                  borderWidth: 1,
                  barThickness: 15,	
                  maxBarThickness: 20
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: {
                  beginAtZero: true,
                  grid: { color: 'rgba(0, 0, 0, 0.1)' },	
                  ticks: {	
                    color: COLORS.textDark,	
                    callback: function(value) {
                      if (Number.isInteger(value)) {
                        return value;
                      }
                    }
                  },
                  title: {
                    display: true,
                    text: 'Conteo de Acciones',
                    color: COLORS.textDark
                  }
                },
                x: {
                  grid: { display: false },
                  ticks: {	
                    color: COLORS.textDark	
                  }
                }
              },
              plugins: {
                legend: {
                  display: true,
                  labels: { color: COLORS.textDark }	
                },
                tooltip: {
                  callbacks: {
                    label: (context) => {
                      return ` ${context.dataset.label}: ${context.formattedValue}`;
                    }
                  }
                }
              }
            }
          });
        }
        // --- FIN FUNCIÓN RENDERIZAR EL GRÁFICO DE BARRAS DOBLES ---

        // --- FUNCIÓN PARA RENDERIZAR ESTADÍSTICAS GENERALES (TABLA Y PREPARACIÓN DE DATOS) ---
        function renderGeneralStats() {
          generalStatsContainer.innerHTML = '';
          
          if (actionLog.length === 0) {
            generalStatsContainer.innerHTML = '<p class="stat-row-text-dark text-center py-8">Registra acciones para ver el resumen.</p>';
            renderBarChart({});	
            return;
          }

          // 1. Inicializar el resumen por tipo de acción
          const summary = {};
          Object.values(actionGroups).forEach(groupName => {
            summary[groupName] = { positive: 0, negative: 0, total: 0, score: 0 };
          });

          // 2. Procesar el log de acciones
          actionLog.forEach(log => {
            const actionCode = log.actionName.substring(0, 1);
            const actionType = actionGroups[actionCode];
            const value = actions[log.actionName];
            const quantity = log.quantity;
            
            if (actionType) {
              summary[actionType].total += quantity;
              summary[actionType].score += (value * quantity);
              
              if (value > 0) {
                summary[actionType].positive += quantity;
              } else if (value < 0) {
                // Almacenamos el CONTEO de acciones negativas
                summary[actionType].negative += quantity;	
              }
            }
          });

          // 3. Crear el encabezado de la tabla (Texto oscuro)
          const header = document.createElement('div');
          header.className = 'grid grid-cols-[minmax(0,2fr)_repeat(4,minmax(0,1fr))] gap-4 font-semibold stat-row-text-dark text-sm mb-2 px-3';
          header.innerHTML = `
            <span class="text-left">Acción</span>
            <span class="text-center">Pos</span>
            <span class="text-center">Neg</span>
            <span class="text-center">Total</span>
            <span class="text-right">Puntos</span>
          `;
          generalStatsContainer.appendChild(header);

          // 4. Recolectar datos para el gráfico y renderizar filas
          const chartData = { labels: [], positiveData: [], negativeData: [] };
          
          Object.keys(summary).sort().forEach(actionType => {
            const stats = summary[actionType];
            if (stats.total > 0) {
              
              // Datos para el gráfico: Conteo de Positivos y Negativos
              chartData.labels.push(actionType);
              chartData.positiveData.push(stats.positive);
              chartData.negativeData.push(stats.negative);	

              const rowDiv = document.createElement('div');
              // Usar la clase clara para el fondo de la fila (gris claro)
              rowDiv.className = 'grid grid-cols-[minmax(0,2fr)_repeat(4,minmax(0,1fr))] gap-4 items-center stat-row-bg p-3 rounded-md';

              const actionNameSpan = document.createElement('span');
              actionNameSpan.className = 'font-bold stat-row-text-dark';
              actionNameSpan.textContent = actionType;
              rowDiv.appendChild(actionNameSpan);

              const positiveSpan = document.createElement('span');
              // Mantener clases de color para Pos/Neg
              positiveSpan.className = 'text-center score-positive font-medium stat-row-text-dark';
              positiveSpan.textContent = `+${stats.positive}`;
              rowDiv.appendChild(positiveSpan);

              const negativeSpan = document.createElement('span');
              // Mantener clases de color para Pos/Neg
              negativeSpan.className = 'text-center score-negative font-medium stat-row-text-dark';
              negativeSpan.textContent = stats.negative;
              rowDiv.appendChild(negativeSpan);
              
              const totalActionsSpan = document.createElement('span');
              totalActionsSpan.className = 'text-center stat-row-text-dark font-medium';
              totalActionsSpan.textContent = stats.total;
              rowDiv.appendChild(totalActionsSpan);
              
              const scoreSpan = document.createElement('span');
              // Mantener clases de color para Score Neutral
              scoreSpan.className = 'font-bold text-lg text-right score-neutral stat-row-text-dark';
              scoreSpan.textContent = stats.score;
              rowDiv.appendChild(scoreSpan);

              generalStatsContainer.appendChild(rowDiv);
            }
          });
          
          // 5. Renderizar el gráfico con los datos separados
          renderBarChart(chartData);	
        }
        // --- FIN FUNCIÓN RENDERIZAR ESTADÍSTICAS GENERALES ---


        function render() {
          // Renderizar tabla de atletas
          playerSelect.innerHTML = '';
          if (players.length === 0) {
            playerSelect.innerHTML = '<option disabled selected>Agrega un atleta primero</option>';
          } else {
            players.forEach((player, index) => {
              const option = document.createElement('option');
              option.value = index;
              option.textContent = `#${player.number} - ${player.name}`;
              playerSelect.appendChild(option);
            });
          }

          scoresContainer.innerHTML = '';
          if (players.length === 0) {
            scoresContainer.innerHTML = '<p class="stat-row-text-dark text-center py-8">Aún no hay atletas. ¡Agrégalos para empezar!</p>';
          } else {
            const header = document.createElement('div');
            // Añadir stat-row-text-dark para que el encabezado sea oscuro
            header.className = 'grid grid-cols-[minmax(0,2fr)_repeat(5,minmax(0,1fr))] gap-4 font-semibold stat-row-text-dark text-sm mb-2 px-3';
            header.innerHTML = `
              <span class="text-left">Atleta</span>
              <span class="text-center">Pos</span>
              <span class="text-center">Neg</span>
              <span class="text-center">Total</span>	
              <span class="text-right">Puntos</span>
              <span class="text-center"> % </span>
            `;
            scoresContainer.appendChild(header);

            players.slice().sort((a, b) => b.score - a.score).forEach(player => {
              const scoreDiv = document.createElement('div');
              // Usar la clase clara para el fondo de la fila (gris claro)
              scoreDiv.className = 'grid grid-cols-[minmax(0,2fr)_repeat(5,minmax(0,1fr))] gap-4 items-center stat-row-bg p-3 rounded-md';

              const playerInfo = document.createElement('span');
              playerInfo.className = 'truncate';
              // Asegurar que el texto del atleta es oscuro
              playerInfo.innerHTML = `<span class="font-bold stat-row-text-dark">#${player.number}</span> <span class="stat-row-text-dark">${player.name}</span>`;

              const positiveScore = document.createElement('span');
              // Mantener clases de color para Pos/Neg, y texto oscuro
              positiveScore.className = 'text-center score-positive font-medium stat-row-text-dark';
              positiveScore.textContent = `+${player.positiveScore}`;

              const negativeScore = document.createElement('span');
              // Mantener clases de color para Pos/Neg, y texto oscuro
              negativeScore.className = 'text-center score-negative font-medium stat-row-text-dark';
              negativeScore.textContent = player.negativeScore;

              const totalActionsCount = document.createElement('span');
              // Asegurar que el texto del conteo es oscuro
              totalActionsCount.className = 'text-center stat-row-text-dark font-medium';	
              totalActionsCount.textContent = player.totalActions;	

              const totalScore = document.createElement('span');
              // Mantener clases de color para Score Neutral, y texto oscuro
              totalScore.className = 'font-bold text-xl text-right score-neutral stat-row-text-dark';	
              totalScore.textContent = player.score;

              const efficiencySpan = document.createElement('span');
              // Asegurar que el texto de eficiencia es oscuro
              efficiencySpan.className = 'text-center font-semibold text-lg stat-row-text-dark';
              let efficiency = 0;
              if (player.totalActions > 0) {
                efficiency = (player.positiveScore / player.totalActions) * 100;
              }
              efficiencySpan.textContent = `${efficiency.toFixed(1)}%`;
              // Las clases de color usan el CSS de la sección <style>
              if (efficiency >= 60) efficiencySpan.classList.add('score-positive');
              else if (efficiency < 40 && efficiency > 0) efficiencySpan.classList.add('score-negative');
              else efficiencySpan.classList.add('score-neutral');	

              scoreDiv.appendChild(playerInfo);
              scoreDiv.appendChild(positiveScore);
              scoreDiv.appendChild(negativeScore);
              scoreDiv.appendChild(totalActionsCount);	
              scoreDiv.appendChild(totalScore);	 	 	
              scoreDiv.appendChild(efficiencySpan);	
              scoresContainer.appendChild(scoreDiv);
            });
          }
          
          // Llamar a la función de renderizado de estadísticas generales y gráfico
          renderGeneralStats();
        }

        // --- FUNCIONES DE REINICIO ---

        function clearSetData() {
          if (confirm('¿Estás seguro de que deseas reiniciar las estadísticas del Set (Puntos y Acciones)? El número y nombre de los atletas se mantendrán.')) {
            actionLog = [];	
            players = players.map(player => ({
              number: player.number,
              name: player.name,
              score: 0,
              positiveScore: 0,
              negativeScore: 0,
              totalActions: 0
            }));
            savePlayers();	
            render();
          }
        }
        
        function clearGameData() {
          if (confirm('ADVERTENCIA: ¿Estás seguro de que deseas reiniciar TODO (Eliminar Datos del Juego), incluyendo atletas y estadísticas? Esta acción es irreversible.')) {
            players = [];	
            actionLog = [];
            localStorage.removeItem('volleyballPlayers');	
            localStorage.removeItem('volleyballActionLog');	
            playerNumberInput.value = '';
            playerNameInput.value = '';
            playerSelect.innerHTML = '<option disabled selected>Agregar atleta primero</option>';	
            actionForm.reset();	
            render();	
          }
        }
        
        function addPlayer() {
          const number = playerNumberInput.value;
          const name = playerNameInput.value.trim();

          if (number && name && !players.some(p => p.number === number)) {
            players.push({
              number: number,
              name: name,
              score: 0,
              positiveScore: 0,
              negativeScore: 0,
              totalActions: 0
            });
            players.sort((a,b) => parseInt(a.number, 10) - parseInt(b.number, 10));
            playerNumberInput.value = '';
            playerNameInput.value = '';
            savePlayers();	
            render();
          } else if (!number || !name) {
            alert('Por favor, ingresa el número y el nombre del atleta.');
          } else {
            alert('Este número de atleta ya existe.');
          }
          playerNumberInput.focus();
        }

        // --- LISTENERS ---
        
        actionSelect.addEventListener('change', setActionSelectColor);

        addPlayerBtn.addEventListener('click', addPlayer);
        playerNameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addPlayer(); });
        playerNumberInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') playerNameInput.focus(); });
        
        clearSetDataBtn.addEventListener('click', clearSetData);	
        clearGameDataBtn.addEventListener('click', clearGameData);	

        actionForm.addEventListener('submit', (e) => {
          e.preventDefault();
          if (players.length === 0) return alert('Debes agregar al menos un atleta.');

          const playerIndex = playerSelect.value;
          const actionName = actionSelect.value;
          const quantity = parseInt(quantityInput.value, 10);

          if (playerIndex !== null && actionName && quantity >= 1) {
            const actionValue = actions[actionName];
            const points = actionValue * quantity;

            // 1. Actualizar estadísticas del atleta
            players[playerIndex].score += points;
            players[playerIndex].totalActions += quantity;

            if (actionValue > 0) players[playerIndex].positiveScore += points;
            // Contar acciones negativas para el score del atleta (no puntos)
            else if (actionValue < 0) players[playerIndex].negativeScore += quantity;
            
            // 2. Registrar la acción en el log para el resumen general
            actionLog.push({
              playerIndex: playerIndex,
              actionName: actionName,
              quantity: quantity
            });

            savePlayers();	
            render();
          } else {
            alert('Por favor, selecciona un atleta y una acción válida.');
          }
        });

        populateActions();
        render();
        
        // Bloqueo de clics y teclas
        document.addEventListener('contextmenu', function(e) {
          e.preventDefault();	
        });

        document.addEventListener('keydown', function(e) {
          if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I') || (e.ctrlKey && e.key === 'u')) {
            e.preventDefault();
          }
        });

      });
    </script>
  </body>
</html>
