<!DOCTYPE html>
<html lang="es">
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Voley Stats Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <style>
        :root{
            --color-main-bg:#F7F8FA;
            --color-card-bg:#ffffff;
            --color-text-dark:#1f2937;
            --color-primary-blue:#0056FF;
            --color-secondary-red:#dc2626;
            --color-neutral-orange:#f97316;
            --color-stat-row-bg:#f3f4f6
        }
        body{
            font-family:'Inter',sans-serif;
            user-select:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;
            background-color:var(--color-main-bg)
        }
        .card{
            background-color:var(--color-card-bg);
            color:var(--color-text-dark);
            border:1px solid #d1d5db;
            transition:transform .2s ease-in-out,box-shadow .2s ease-in-out;
            box-shadow:0 4px 10px -1px rgba(0,86,255,.1),0 2px 5px -2px rgba(0,86,255,.05)
        }
        .card:hover{
            transform:translateY(-2px);
            box-shadow:0 8px 15px -3px rgba(0,86,255,.2),0 4px 8px -2px rgba(0,86,255,.1)
        }
        .stat-row-bg{background-color:var(--color-stat-row-bg)}
        .stat-row-text-dark{color:var(--color-text-dark)}
        .score-positive{color:var(--color-primary-blue)}
        .score-negative{color:var(--color-secondary-red)}
        .score-neutral{color:var(--color-neutral-orange)}
        input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}
        input[type=number]{-moz-appearance:textfield}
        input,select{border:1px solid #d1d5db!important;background-color:var(--color-card-bg)!important;color:var(--color-text-dark)!important}
        input:focus,select:focus{box-shadow:0 0 0 2px var(--color-card-bg),0 0 0 4px var(--color-primary-blue)}
        #actionSelect{color:var(--color-text-dark)!important}
        footer{padding:1.5rem 0;text-align:center;width:100%;max-w-5xl;margin-top:2rem;border-top:1px solid #e5e7eb;font-size:.875rem;color:#6b7280}
        footer strong{color:var(--color-text-dark);font-weight:500}

        /* Estilo para el aviso automático (Toast) */
        .toast-notification {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: #1f2937;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            z-index: 9999;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
        }
        .toast-visible {
            opacity: 1;
        }
    </style>
</head>

<body class="text-gray-800 min-h-screen flex flex-col items-center p-4">
    <main class="w-full max-w-5xl mx-auto space-y-8 shadow-sm">
        <header class="text-center relative">
            <a href="../index_menu.html" class="absolute top-0 right-0 font-bold py-2 px-4 rounded-md transition-colors text-sm shadow-md" style="background-color: var(--color-primary-blue); color: white;" onmouseover="this.style.backgroundColor='#007bff';" onmouseout="this.style.backgroundColor='var(--color-primary-blue)';" aria-label="Regresar al Menú">Regresar al Menú</a>
            <h1 class="text-4xl font-extrabold tracking-tight stat-row-text-dark sm:text-5xl">Control Voley <span class="text-yellow-600">Stats Tracker</span></h1>
            <p class="mt-4 text-lg text-gray-500 font-medium">Monitorea el rendimiento y la eficiencia de tus atletas en tiempo real.</p>
        </header>

        <div class="grid grid-cols-1 gap-8">
            <div class="space-y-6">
                <div class="card p-6 rounded-lg">
                    <h2 class="text-2xl font-semibold mb-4 pb-2" style="border-bottom: 1px solid var(--color-primary-blue); color: var(--color-primary-blue);">Registrar Atleta</h2>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <input id="playerNumberInput" placeholder="Nro." class="w-full sm:w-24 rounded-md px-3 py-2 focus:outline-none" type="number" style="--tw-ring-color: var(--color-primary-blue);">
                        <input id="playerNameInput" placeholder="Nombre del Atleta" class="flex-grow rounded-md px-3 py-2 focus:outline-none" type="text" style="--tw-ring-color: var(--color-primary-blue);">
                        <button id="addPlayerBtn" class="text-white font-bold py-2 px-4 rounded-md transition-colors shadow-lg" style="background-color: var(--color-primary-blue);" onmouseover="this.style.backgroundColor='#007bff';" onmouseout="this.style.backgroundColor='var(--color-primary-blue)';">Agregar</button>
                    </div>
                </div>

                <div class="card p-6 rounded-lg">
                    <h2 class="text-2xl font-semibold mb-4 pb-2" style="border-bottom: 1px solid var(--color-primary-blue); color: var(--color-primary-blue);">Registrar Acción</h2>
                    <form id="actionForm" class="space-y-4">
                        <div>
                            <label for="playerSelect" class="block mb-2 text-sm font-medium stat-row-text-dark">Seleccionar Atleta</label>
                            <select id="playerSelect" class="w-full rounded-md px-3 py-2 focus:outline-none" style="--tw-ring-color: var(--color-primary-blue);">
                                <option disabled="disabled" selected="selected">Agregar atleta primero</option>
                            </select>
                        </div>
                        <div>
                            <label for="actionSelect" class="block mb-2 text-sm font-medium stat-row-text-dark">Tipo de Acción</label>
                            <select id="actionSelect" class="w-full rounded-md px-3 py-2 focus:outline-none" style="--tw-ring-color: var(--color-primary-blue);"></select>
                        </div>
                        <div class="hidden">
                            <label for="quantityInput" class="block mb-2 text-sm font-medium stat-row-text-dark">Cantidad</label>
                            <input id="quantityInput" value="1" min="1" class="w-full rounded-md px-3 py-2 focus:outline-none" type="number" style="--tw-ring-color: var(--color-primary-blue);">
                        </div>
                        <button type="submit" class="w-full text-white font-bold py-2 px-4 rounded-md transition-colors shadow-lg" style="background-color: var(--color-primary-blue);" onmouseover="this.style.backgroundColor='#007bff';" onmouseout="this.style.backgroundColor='var(--color-primary-blue)';">Registrar</button>
                        <button type="button" id="clearSetDataBtn" class="w-full text-white font-bold py-2 px-4 rounded-md transition-colors mt-4 shadow-md" style="background-color: #d97706;" onmouseover="this.style.backgroundColor='#b45309';" onmouseout="this.style.backgroundColor='#d97706';">Eliminar Datos del Set</button>
                        <button type="button" id="clearGameDataBtn" class="w-full text-white font-bold py-2 px-4 rounded-md transition-colors mt-4 shadow-md" style="background-color: var(--color-secondary-red);" onmouseover="this.style.backgroundColor='#ef4444';" onmouseout="this.style.backgroundColor='var(--color-secondary-red)';">Eliminar Datos del Juego</button>
                    </form>
                </div>
            </div>

            <div class="card p-6 rounded-lg">
                <h2 class="text-2xl font-semibold mb-4 pb-2" style="border-bottom: 1px solid var(--color-primary-blue); color: var(--color-primary-blue);">Estadística por Atleta</h2>
                <div id="scoresContainer" class="space-y-3">
                    <p class="stat-row-text-dark text-center py-8">Aún no hay atletas. ¡Agrégalos para empezar!</p>
                </div>
            </div>

            <div class="card p-6 rounded-lg mt-8">
                <h2 class="text-2xl font-semibold mb-4 pb-2" style="border-bottom: 1px solid var(--color-primary-blue); color: var(--color-primary-blue);">Estadística General por Equipo</h2>
                <div id="generalStatsContainer" class="space-y-3">
                    <p class="stat-row-text-dark text-center py-8">Registra acciones para ver el resumen.</p>
                </div>
            </div>

            <div class="card p-6 rounded-lg mt-8">
                <h2 class="text-2xl font-semibold mb-4 pb-2" style="border-bottom: 1px solid var(--color-primary-blue); color: var(--color-primary-blue);">Gráfica General del Equipo (Positivos vs Negativos - Set Actual)</h2>
                <div class="h-96">
                    <canvas id="barChart"></canvas>
                </div>
            </div>
            
            <div class="card p-6 rounded-lg mt-8">
                <h2 class="text-2xl font-semibold mb-4 pb-2" style="border-bottom: 1px solid var(--color-primary-blue); color: var(--color-primary-blue);">Gráfica de Acciones por Tipo (Acumulado del Juego)</h2>
                <div class="h-96">
                    <canvas id="accumulatedBarChart"></canvas>
                </div>
                <div id="totalPointsSummary" class="text-center mt-4 text-lg font-semibold stat-row-text-dark">
                    </div>
            </div>
        </div>
    </main>

    <footer class="mt-8 text-sm w-full max-w-5xl">
        <p>Copyright © Empresa Sistematikos. Todos los derechos reservados.</p>
        <p>Diseñado por <strong>Sistematikos - Frank Hernandez</strong></p>
    </footer>

    <script>
        let barChartInstance = null;
        let accumulatedBarChartInstance = null; 

        document.addEventListener('DOMContentLoaded', () => {
            const a = document.getElementById('playerNumberInput'),
                b = document.getElementById('playerNameInput'),
                c = document.getElementById('addPlayerBtn'),
                d = document.getElementById('playerSelect'),
                e = document.getElementById('actionSelect'),
                f = document.getElementById('quantityInput'),
                g = document.getElementById('actionForm'),
                h = document.getElementById('scoresContainer'),
                i = document.getElementById('generalStatsContainer'),
                j = document.getElementById('clearSetDataBtn'),
                k = document.getElementById('clearGameDataBtn');
            
            let l = [], m = [], m_current_set = [];

            const n = { 
                'S# Servicio Positivo': 1, 'A# Ataque Positivo': 1, 'B# Bloqueo Positivo': 1, 
                'R# Recepción Positiva': 1, 'C# Coloque Positivo': 1, 'D# Defensa Positiva': 1,
                'S= Servicio Negativo': -1, 'A= Ataque Negativo': -1, 'B= Bloqueo Negativo': -1, 
                'R= Recepción Negativo': -1, 'C= Coloque Negativo': -1, 'D= Defensa Negativa': -1
            },
            o = { S: 'Servicio', A: 'Ataque', B: 'Bloqueo', R: 'Recepción', C: 'Coloque', D: 'Defensa' },
            p = { primaryBlue: '#0056FF', secondaryRed: '#dc2626', textDark: '#1f2937', cardBg: '#ffffff', neutralOrange: '#f97316', successGreen: '#10b981' };

            // --- FUNCIÓN PARA AVISO AUTOMÁTICO ---
            function showAutoToast(message) {
                const toast = document.createElement('div');
                toast.className = 'toast-notification';
                toast.textContent = message;
                document.body.appendChild(toast);

                // Aparecer
                setTimeout(() => toast.classList.add('toast-visible'), 10);

                // Desaparecer después de 2 segundos
                setTimeout(() => {
                    toast.classList.remove('toast-visible');
                    setTimeout(() => toast.remove(), 300);
                }, 2000);
            }

            function q() {
                localStorage.setItem('volleyballPlayers', JSON.stringify(l));
                localStorage.setItem('volleyballActionLog', JSON.stringify(m)); 
                localStorage.setItem('volleyballCurrentSetLog', JSON.stringify(m_current_set)); 
            }
            
            function r() {
                const a = localStorage.getItem('volleyballPlayers');
                a && (l = JSON.parse(a));
                const b = localStorage.getItem('volleyballActionLog');
                b && (m = JSON.parse(b));
                const setLog = localStorage.getItem('volleyballCurrentSetLog');
                setLog && (m_current_set = JSON.parse(setLog));
            }

            function s() {
                const a = e.options[e.selectedIndex], b = a ? a.value : null, c = b ? n[b] : 0;
                c > 0 ? e.style.borderColor = p.primaryBlue : c < 0 ? e.style.borderColor = p.secondaryRed : e.style.borderColor = '#d1d5db';
                return c;
            }

            function populatePlayerSelect() {
                d.innerHTML = '';
                if (l.length === 0) {
                    d.innerHTML = '<option disabled selected>Agregar atleta primero</option>';
                    return;
                }
                l.sort((p1, p2) => p1.number - p2.number);
                l.forEach(player => {
                    const option = document.createElement('option');
                    option.value = player.number;
                    option.textContent = `#${player.number} - ${player.name}`;
                    d.appendChild(option);
                });
            }

            function populateActionSelect() {
                e.innerHTML = '';
                Object.keys(n).forEach(action => {
                    const option = document.createElement('option');
                    option.value = action;
                    option.textContent = action;
                    e.appendChild(option);
                });
                s();
            }

            function updateScoreContainer() {
                h.innerHTML = ''; 
                if (l.length === 0) {
                    h.innerHTML = '<p class="stat-row-text-dark text-center py-8">Aún no hay atletas. ¡Agrégalos para empezar!</p>';
                    return;
                }
                const playerStats = {};
                l.forEach(player => { playerStats[player.number] = { totalPos: 0, totalNeg: 0, efficiency: 0, differential: 0, totalActions: 0, actions: {} }; });
                m_current_set.forEach(log => {
                    const stats = playerStats[log.playerNumber];
                    const score = n[log.action];
                    const quantity = log.quantity || 1;
                    const actionType = log.action.charAt(0); 
                    if (stats) {
                        stats.totalActions += quantity;
                        if (score > 0) stats.totalPos += quantity;
                        else if (score < 0) stats.totalNeg += quantity;
                        if (!stats.actions[actionType]) stats.actions[actionType] = { pos: 0, neg: 0 };
                        if (score > 0) stats.actions[actionType].pos += quantity;
                        else if (score < 0) stats.actions[actionType].neg += quantity;
                    }
                });
                l.forEach(player => {
                    const stats = playerStats[player.number];
                    const totalActions = stats.totalPos + stats.totalNeg;
                    stats.differential = stats.totalPos - stats.totalNeg;
                    stats.efficiency = totalActions > 0 ? (stats.differential / totalActions) * 100 : 0;
                    let actionDetails = '';
                    Object.keys(o).forEach(key => {
                        const typeStats = stats.actions[key];
                        if (typeStats) actionDetails += `<span class="text-sm font-medium mr-3">${key}: <span class="score-positive">${typeStats.pos}</span> | <span class="score-neutral" style="color: ${p.neutralOrange};">${typeStats.neg}</span></span>`;
                    });
                    const differentialColor = stats.differential > 0 ? p.successGreen : (stats.differential < 0 ? p.secondaryRed : p.textDark);
                    h.innerHTML += `
                        <div class="stat-row-bg p-3 rounded-lg flex flex-col shadow-sm">
                            <div class="flex justify-between items-center mb-2">
                                <div class="font-bold text-lg stat-row-text-dark">#${player.number} ${player.name}</div>
                                <div class="text-right"><span class="font-bold text-xl" style="color: ${stats.efficiency >= 0 ? p.successGreen : p.secondaryRed};">${stats.efficiency.toFixed(1)}%</span></div>
                            </div>
                            <div class="flex justify-between text-sm py-1 border-b border-gray-300">
                                <span class="font-semibold stat-row-text-dark">Acciones:</span>
                                <div class="text-xs">${actionDetails || 'Sin acciones.'}</div>
                            </div>
                            <div class="flex justify-between text-base pt-2">
                                <span class="font-bold stat-row-text-dark">Dif. Neto:</span>
                                <span class="font-extrabold" style="color: ${differentialColor};">${stats.differential > 0 ? '+' : ''}${stats.differential}</span>
                            </div>
                        </div>`;
                });
            }

            function updateGeneralStats() {
                i.innerHTML = '';
                if (m_current_set.length === 0) {
                    i.innerHTML = '<p class="stat-row-text-dark text-center py-8">Registra acciones para ver el resumen.</p>';
                    return;
                }
                const teamStats = {};
                let totalActions = 0, teamPos = 0, teamNeg = 0;
                m_current_set.forEach(log => {
                    const score = n[log.action], quantity = log.quantity || 1, actionType = log.action.charAt(0);
                    if (!teamStats[actionType]) teamStats[actionType] = { pos: 0, neg: 0 };
                    if (score > 0) { teamStats[actionType].pos += quantity; teamPos += quantity; }
                    else if (score < 0) { teamStats[actionType].neg += quantity; teamNeg += quantity; }
                    totalActions += quantity;
                });
                const totalEfficiency = totalActions > 0 ? ((teamPos - teamNeg) / totalActions) * 100 : 0;
                let statsHtml = `<div class="flex justify-between items-center stat-row-bg p-3 rounded-lg font-bold"><span>Eficiencia Equipo:</span><span class="text-xl" style="color: ${totalEfficiency >= 0 ? p.successGreen : p.secondaryRed};">${totalEfficiency.toFixed(1)}%</span></div>`;
                Object.keys(o).forEach(key => {
                    const stats = teamStats[key];
                    if (stats) {
                        const typeTotal = stats.pos + stats.neg;
                        const typeEff = typeTotal > 0 ? ((stats.pos - stats.neg) / typeTotal) * 100 : 0;
                        statsHtml += `<div class="p-3 border-b border-gray-200 flex justify-between stat-row-text-dark"><span>${o[key]}:</span><span><span class="score-positive">${stats.pos}</span> | <span class="score-neutral" style="color: ${p.neutralOrange};">${stats.neg}</span> | <span class="font-medium" style="color: ${typeEff >= 0 ? p.primaryBlue : p.secondaryRed};">${typeEff.toFixed(0)}%</span></span></div>`;
                    }
                });
                i.innerHTML = statsHtml;
            }

            function updateBarChart() {
                const actionTotals = {};
                Object.keys(o).forEach(key => actionTotals[key] = { pos: 0, neg: 0 });
                m_current_set.forEach(log => {
                    const score = n[log.action], qty = log.quantity || 1, type = log.action.charAt(0);
                    if (actionTotals[type]) { if (score > 0) actionTotals[type].pos += qty; else if (score < 0) actionTotals[type].neg += qty; }
                });
                const labels = Object.values(o);
                const posData = labels.map(l => actionTotals[Object.keys(o).find(k => o[k] === l)]?.pos || 0);
                const negData = labels.map(l => actionTotals[Object.keys(o).find(k => o[k] === l)]?.neg || 0);
                if (barChartInstance) barChartInstance.destroy();
                const ctx = document.getElementById('barChart').getContext('2d');
                barChartInstance = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Positivas', data: posData, backgroundColor: p.primaryBlue }, { label: 'Negativas', data: negData, backgroundColor: p.neutralOrange }] }, options: { responsive: true, maintainAspectRatio: false }});
            }

            function updateAccumulatedBarChart() {
                const actionTotals = {};
                let totalPos = 0, totalNeg = 0;
                Object.keys(o).forEach(key => actionTotals[key] = { pos: 0, neg: 0 });
                m.forEach(log => {
                    const score = n[log.action], qty = log.quantity || 1, type = log.action.charAt(0);
                    if (actionTotals[type]) { if (score > 0) { actionTotals[type].pos += qty; totalPos += qty; } else if (score < 0) { actionTotals[type].neg += qty; totalNeg += qty; } }
                });
                const labels = Object.values(o), posData = labels.map(l => actionTotals[Object.keys(o).find(k => o[k] === l)]?.pos || 0), negData = labels.map(l => actionTotals[Object.keys(o).find(k => o[k] === l)]?.neg || 0);
                const totalActions = totalPos + totalNeg, ctx = document.getElementById('accumulatedBarChart').getContext('2d'), summaryDiv = document.getElementById('totalPointsSummary'), chartContainer = document.getElementById('accumulatedBarChart');
                if (totalActions === 0) { summaryDiv.innerHTML = 'Sin acciones acumuladas.'; chartContainer.style.display = 'none'; if (accumulatedBarChartInstance) { accumulatedBarChartInstance.destroy(); accumulatedBarChartInstance = null; } return; }
                chartContainer.style.display = 'block';
                summaryDiv.innerHTML = `<p class="score-positive">Positivos: ${totalPos}</p><p class="score-neutral" style="color: ${p.neutralOrange};">Negativos: ${totalNeg}</p>`;
                if (accumulatedBarChartInstance) accumulatedBarChartInstance.destroy();
                accumulatedBarChartInstance = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Pos. Acumulado', data: posData, backgroundColor: p.primaryBlue }, { label: 'Neg. Acumulado', data: negData, backgroundColor: p.neutralOrange }] }, options: { responsive: true, maintainAspectRatio: false }});
            }

            function updateAllStats() { updateScoreContainer(); updateGeneralStats(); updateBarChart(); updateAccumulatedBarChart(); }

            c.addEventListener('click', () => {
                const number = parseInt(a.value.trim()), name = b.value.trim();
                if (isNaN(number) || name === '') { alert('Datos inválidos.'); return; }
                if (l.some(p => p.number === number)) { alert('Número ya asignado.'); return; }
                l.push({ number: number, name: name });
                q(); populatePlayerSelect(); updateAllStats(); a.value = ''; b.value = '';
                showAutoToast(`Atleta #${number} agregado`);
            });

            e.addEventListener('change', s);

            g.addEventListener('submit', (event) => {
                event.preventDefault();
                const playerNumber = parseInt(d.value), action = e.value, quantity = parseInt(f.value) || 1;
                if (!playerNumber) { alert('Selecciona un atleta.'); return; }
                const logEntry = { playerNumber: playerNumber, action: action, quantity: quantity, timestamp: new Date().toISOString() };
                m.push(logEntry); m_current_set.push(logEntry);
                q(); updateAllStats(); 
                
                // CAMBIO SOLICITADO: Aviso automático de 2 segundos sin botón aceptar
                showAutoToast(`Acción registrada: #${playerNumber}`);
            });

            j.addEventListener('click', () => {
                if (confirm('¿Eliminar datos del SET?')) { m_current_set = []; q(); updateAllStats(); showAutoToast('Set reiniciado'); }
            });

            k.addEventListener('click', () => {
                if (confirm('¿ELIMINAR TODO EL JUEGO?')) { l = []; m = []; m_current_set = []; q(); window.location.reload(); }
            });

            r(); populateActionSelect(); populatePlayerSelect(); updateAllStats();
        });
    </script>
</body>
</html>
